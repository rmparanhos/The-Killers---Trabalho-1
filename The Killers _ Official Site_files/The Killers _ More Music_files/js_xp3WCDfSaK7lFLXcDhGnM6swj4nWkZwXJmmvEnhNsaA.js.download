/*globals jQuery, Drupal, require, define, Modernizr*/
/**
 * IGA Webform customizations
 */
define("IGA.common.webform", ["jquery", "IGA.events"], function($, events){
	"use strict";
	var Webform = {
		//## Convert Drupal datepicker into a simple html5 date field.
		dateInput: function(index, el, suffix){
			var $date = $(el),
				$datepicker = $date.find(".webform-container-inline, .container-inline, .container-inline-date" ),
				$day = $datepicker.find("select.day, select.date-day, input.day, select[name$=\"[day]\"]"),
				$month = $datepicker.find("select.month, select.date-month, input.month, select[name$=\"[month]\"]"),
				$year = $datepicker.find("select.year, select.date-year, input.year, select[name$=\"[year]\"]"),
				name = ($month.attr("name") || "").split("[")[0],
				$input;
			suffix = suffix || "iga";
			$input = $date.find("input[type=date]");
			if($input.length === 0){
				$input = $('<input class="iga-common-webform-date" type="date">');
			}else{
				$input.addClass("iga-common-webform-date").show();
			}
			if(name !== ""){
				// If the input is provided then we're using it to submit, update the name. It can't conflict w/ the Drupal form field.
				$input.attr("name", name +"."+suffix);
			}

			$datepicker.hide().after($input);
			$input.on("change", function(){
				//### When the date input is updated
				var date = $input.val().split("-"), //yy-mm-dd regardless of user display
					year = date[0],
					month = date[1],
					day = date[2];
				if(month){ $month.val(month.replace(/^0/,'')); }
				if(day){ $day.val(day.replace(/^0/,'')); }
				if(year){ $year.val(year); }
			});
			//### Initialize the date input with the datepicker
			var day = $day.val(),
				month = $month.val(),
				year = $year.val();
			if(day && day.length === 1){ day = "0"+day; }
			if(month && month.length === 1){ month = "0"+month; }
			if(year && year !== "" && day !== "" && month !== ""){
				require(["IGA.utils"], function(utils){
					var _date = year+"-"+month+"-"+day,
						now = new Date();
					// Turn off input initialization if the date is set to today / the default
					if(utils.dateFormat(now.getTime() + now.getTimezoneOffset() * 60000, 'yyyy-mm-dd') !== _date){
						$input.val(_date);
					}
				});
			}
			var autocomplete = $month.attr("autocomplete");
			if(autocomplete && autocomplete.indexOf("bday") === 0){
				$input.attr("autocomplete", "bday");
			}
		},
		//## Add autocomplete attributes to date selects.
		dobAutoComplete: function(index, el){
			var $date = $(el),
				$datepicker = $date.find(".webform-container-inline"),
				$day = $datepicker.find("select.day, select.date-day"),
				$month = $datepicker.find("select.month, select.date-month"),
				$year = $datepicker.find("select.year, select.date-year, input.year"),
				autocomplete = $datepicker.find("select.month").attr("autocomplete");
			if(autocomplete && autocomplete.indexOf("bday") === 0){
				$day.attr("autocomplete", "bday-day");
				$month.attr("autocomplete", "bday-month");
				$year.attr("autocomplete", "bday-year");
			}

		},
		//## Apply phone number field formatting.
		phoneInput: function(index, el){
			var $el = $(el);
			require(["jquery", "jquery/formance/jquery.formance.min"], function($){
				$el.formance('format_phone_number');
			});
		},
		//## Auto-fill form based on user profile.
		updateUser: function($webform, user, ae_user){
			var $email = $webform.find("input.email"),
				$firstname = $webform.find("input[autocomplete='given-name']"),
				$lastname = $webform.find("input[autocomplete='family-name']"),
				$dob = $webform.find("input[autocomplete='bday']"),
				$dob_select = $webform.find(".webform-component-date select[autocomplete='bday-year'], .webform-component-date input[autocomplete='bday-year']"),
				$zip = $webform.find("input[autocomplete='postal-code']"),
				$city = $webform.find("input[autocomplete='address-level2']"),
				$state = $webform.find("input[autocomplete='address-level1']"),
				$country = $webform.find("input[autocomplete='country'], select[autocomplete='country']");

			user = user || {};
			ae_user = ae_user || user.ae_user || {data:{}};

			if($email.length > 0 && !$email.val()){
				$email.val(user.mail || ae_user.data.Email);
			}
			if($firstname.length > 0 && !$firstname.val()){
				$firstname.val(user.field_first_name || ae_user.data.FirstName);
			}
			if($lastname.length > 0 && !$lastname.val()){
				$lastname.val(user.field_last_name || ae_user.data.LastName);
			}

			if($dob.length > 0 || $dob_select.length > 0){
				var dob = null;
				if(user.field_birthday){
					dob = user.field_birthday.split(' ');
					if(dob.length > 0){ dob = dob[0]; }
				}
				dob = dob || ae_user.data.BirthDate || "";
				if($dob.length > 0 && !$dob.val()){
					$dob.val(dob).trigger('change');
				}else if($dob_select.length > 0){
					$dob_select = $dob_select.closest(".webform-component-date ");
					var $day = $dob_select.find("select.day"),
						$month = $dob_select.find("select.month"),
						$year = $dob_select.find("select.year, input.year"),
						dobArr = dob.split("-");
					if(dobArr.length === 3){
						var year = dobArr[0], month = dobArr[1], day = dobArr[2];
						$year.val(year);
						$month.val(month.replace(/^0/,''));
						$day.val(day.replace(/^0/,''));
					}
				}
			}
			var user_address = user.field_user_address || {};
			if($zip.length > 0 && !$zip.val()){
				$zip.val(user_address.postal_code || ae_user.data.PostCode);
			}
			if($city.length > 0 && !$city.val()){
				$city.val(user_address.city || ae_user.data.City);
			}
			if($state.length > 0 && !$state.val()){
				$state.val(user_address.state || ae_user.data.State).trigger("change");
			}
			if($country.length > 0 && !$country.val()){
				$country.val(user_address.country || ae_user.data.CountryCode).trigger("change");
			}
		},
		countryCASL: function($webform){
			var $country = $webform.find('select[name="submitted[country]"], select[autocomplete^="country"]');
			$country.on("change", function(){
				var $this = $(this), country = $this.val();
				events.trigger("country.manual", [country]);
			});
		}
	};
	return Webform;
});

(function(jQuery) {
	"use strict";
	// # Drupal Behaviors
	var dsicw = Drupal.settings.iga_common_webform || {};
	Drupal.behaviors.iga_common_webform = {
		attach: function(context, settings){
			require(["jquery", "IGA.events", "IGA.common.webform"], function($, events, Webform){
				var $context = $(context)

				//### Update form values for logged in users when:
				require(["IGA.user"], function(user){
					var formSelector = "form.webform-client-form.iga-common-webform";
					$context.find(formSelector).addBack(formSelector).once("iga-common-webform", function(){
						var $webform = $(this),
							nid = $webform.attr("data-nid"),
							settings = dsicw["nid-"+nid] || {};

						if (Modernizr && Modernizr.inputtypes.date && settings.html5_date){
							// Add HTML5 date input if it is available;
							$webform.find(".webform-component-date").once("iga-common-webform", Webform.dateInput);
						}else{
							// otherwise, at least add autocomplete date to the select
							$webform.find(".webform-component-date").once("iga-common-webform", Webform.dobAutoComplete);
						}
						$webform.find("#webform-component-phone-number input").once("iga-common-webform", Webform.phoneInput);

						if(user.uid){
							// the user is logged in,
							Webform.updateUser($webform, user);
						}else{
							events.on("login", function(user, data){
								// once the user has logged in,
								Webform.updateUser($webform, user, data ? data.ae_user : null);
							});
						}
						function ae_user(ae_user, state, sso){
							var dbae = Drupal.behaviors.ae_social_login || {};
							// or when the user is logged into AE.
							Webform.updateUser($webform, null, ae_user);
						}

						events.on("ae_user", ae_user).replay("ae_user", ae_user);
						events.on("ae_login", ae_user).replay("ae_login", ae_user);

						// ### CASL
						Webform.countryCASL($webform);

					});
				});
			});
		}
	};

})(jQuery);;
document.createElement("canvas").getContext||!function(){function t(){return this.context_||(this.context_=new l(this))}function e(t,e){var i=S.call(arguments,2);return function(){return t.apply(e,i.concat(S.call(arguments)))}}function i(t){var e=t.srcElement;switch(t.propertyName){case"width":e.style.width=e.attributes.width.nodeValue+"px",e.getContext().clearRect();break;case"height":e.style.height=e.attributes.height.nodeValue+"px",e.getContext().clearRect()}}function r(t){var e=t.srcElement;e.firstChild&&(e.firstChild.style.width=e.clientWidth+"px",e.firstChild.style.height=e.clientHeight+"px")}function s(){return[[1,0,0],[0,1,0],[0,0,1]]}function n(t,e){for(var i=s(),r=0;3>r;r++)for(var n=0;3>n;n++){for(var a=0,o=0;3>o;o++)a+=t[r][o]*e[o][n];i[r][n]=a}return i}function a(t,e){e.fillStyle=t.fillStyle,e.lineCap=t.lineCap,e.lineJoin=t.lineJoin,e.lineWidth=t.lineWidth,e.miterLimit=t.miterLimit,e.shadowBlur=t.shadowBlur,e.shadowColor=t.shadowColor,e.shadowOffsetX=t.shadowOffsetX,e.shadowOffsetY=t.shadowOffsetY,e.strokeStyle=t.strokeStyle,e.globalAlpha=t.globalAlpha,e.arcScaleX_=t.arcScaleX_,e.arcScaleY_=t.arcScaleY_,e.lineScale_=t.lineScale_}function o(t){var e,i=1;if(t=String(t),"rgb"==t.substring(0,3)){var r=t.indexOf("(",3),s=t.indexOf(")",r+1),n=t.substring(r+1,s).split(",");e="#";for(var a=0;3>a;a++)e+=C[Number(n[a])];4==n.length&&"a"==t.substr(3,1)&&(i=n[3])}else e=t;return{color:e,alpha:i}}function h(t){switch(t){case"butt":return"flat";case"round":return"round";case"square":default:return"square"}}function l(t){this.m_=s(),this.mStack_=[],this.aStack_=[],this.currentPath_=[],this.strokeStyle="#000",this.fillStyle="#000",this.lineWidth=1,this.lineJoin="miter",this.lineCap="butt",this.miterLimit=1*x,this.globalAlpha=1,this.canvas=t;var e=t.ownerDocument.createElement("div");e.style.width=t.clientWidth+"px",e.style.height=t.clientHeight+"px",e.style.overflow="hidden",e.style.position="absolute",t.appendChild(e),this.element_=e,this.arcScaleX_=1,this.arcScaleY_=1,this.lineScale_=1}function c(t,e,i,r){t.currentPath_.push({type:"bezierCurveTo",cp1x:e.x,cp1y:e.y,cp2x:i.x,cp2y:i.y,x:r.x,y:r.y}),t.currentX_=r.x,t.currentY_=r.y}function u(t){this.type_=t,this.x0_=0,this.y0_=0,this.r0_=0,this.x1_=0,this.y1_=0,this.r1_=0,this.colors_=[]}function _(){}var p=Math,y=p.round,g=p.sin,d=p.cos,f=p.abs,m=p.sqrt,x=10,v=x/2,S=Array.prototype.slice,w={init:function(t){if(/MSIE/.test(navigator.userAgent)&&!window.opera){var i=t||document;i.createElement("canvas"),i.attachEvent("onreadystatechange",e(this.init_,this,i))}},init_:function(t){if(t.namespaces.g_vml_||t.namespaces.add("g_vml_","urn:schemas-microsoft-com:vml","#default#VML"),t.namespaces.g_o_||t.namespaces.add("g_o_","urn:schemas-microsoft-com:office:office","#default#VML"),!t.styleSheets.ex_canvas_){var e=t.createStyleSheet();e.owningElement.id="ex_canvas_",e.cssText="canvas{display:inline-block;overflow:hidden;text-align:left;width:300px;height:150px}g_vml_\\:*{behavior:url(#default#VML)}g_o_\\:*{behavior:url(#default#VML)}"}for(var i=t.getElementsByTagName("canvas"),r=0;r<i.length;r++)this.initElement(i[r])},initElement:function(e){if(!e.getContext){e.getContext=t,e.innerHTML="",e.attachEvent("onpropertychange",i),e.attachEvent("onresize",r);var s=e.attributes;s.width&&s.width.specified?e.style.width=s.width.nodeValue+"px":e.width=e.clientWidth,s.height&&s.height.specified?e.style.height=s.height.nodeValue+"px":e.height=e.clientHeight}return e}};w.init();for(var C=[],b=0;16>b;b++)for(var T=0;16>T;T++)C[16*b+T]=b.toString(16)+T.toString(16);var P=l.prototype;P.clearRect=function(){this.element_.innerHTML=""},P.beginPath=function(){this.currentPath_=[]},P.moveTo=function(t,e){var i=this.getCoords_(t,e);this.currentPath_.push({type:"moveTo",x:i.x,y:i.y}),this.currentX_=i.x,this.currentY_=i.y},P.lineTo=function(t,e){var i=this.getCoords_(t,e);this.currentPath_.push({type:"lineTo",x:i.x,y:i.y}),this.currentX_=i.x,this.currentY_=i.y},P.bezierCurveTo=function(t,e,i,r,s,n){var a=this.getCoords_(s,n),o=this.getCoords_(t,e),h=this.getCoords_(i,r);c(this,o,h,a)},P.quadraticCurveTo=function(t,e,i,r){var s=this.getCoords_(t,e),n=this.getCoords_(i,r),a={x:this.currentX_+2/3*(s.x-this.currentX_),y:this.currentY_+2/3*(s.y-this.currentY_)},o={x:a.x+(n.x-this.currentX_)/3,y:a.y+(n.y-this.currentY_)/3};c(this,a,o,n)},P.arc=function(t,e,i,r,s,n){i*=x;var a=n?"at":"wa",o=t+d(r)*i-v,h=e+g(r)*i-v,l=t+d(s)*i-v,c=e+g(s)*i-v;o!=l||n||(o+=.125);var u=this.getCoords_(t,e),_=this.getCoords_(o,h),p=this.getCoords_(l,c);this.currentPath_.push({type:a,x:u.x,y:u.y,radius:i,xStart:_.x,yStart:_.y,xEnd:p.x,yEnd:p.y})},P.rect=function(t,e,i,r){this.moveTo(t,e),this.lineTo(t+i,e),this.lineTo(t+i,e+r),this.lineTo(t,e+r),this.closePath()},P.strokeRect=function(t,e,i,r){var s=this.currentPath_;this.beginPath(),this.moveTo(t,e),this.lineTo(t+i,e),this.lineTo(t+i,e+r),this.lineTo(t,e+r),this.closePath(),this.stroke(),this.currentPath_=s},P.fillRect=function(t,e,i,r){var s=this.currentPath_;this.beginPath(),this.moveTo(t,e),this.lineTo(t+i,e),this.lineTo(t+i,e+r),this.lineTo(t,e+r),this.closePath(),this.fill(),this.currentPath_=s},P.createLinearGradient=function(t,e,i,r){var s=new u("gradient");return s.x0_=t,s.y0_=e,s.x1_=i,s.y1_=r,s},P.createRadialGradient=function(t,e,i,r,s,n){var a=new u("gradientradial");return a.x0_=t,a.y0_=e,a.r0_=i,a.x1_=r,a.y1_=s,a.r1_=n,a},P.drawImage=function(t){var e,i,r,s,n,a,o,h,l=t.runtimeStyle.width,c=t.runtimeStyle.height;t.runtimeStyle.width="auto",t.runtimeStyle.height="auto";var u=t.width,_=t.height;if(t.runtimeStyle.width=l,t.runtimeStyle.height=c,3==arguments.length)e=arguments[1],i=arguments[2],n=a=0,o=r=u,h=s=_;else if(5==arguments.length)e=arguments[1],i=arguments[2],r=arguments[3],s=arguments[4],n=a=0,o=u,h=_;else{if(9!=arguments.length)throw Error("Invalid number of arguments");n=arguments[1],a=arguments[2],o=arguments[3],h=arguments[4],e=arguments[5],i=arguments[6],r=arguments[7],s=arguments[8]}var g=this.getCoords_(e,i),d=[],f=10,m=10;if(d.push(" <g_vml_:group",' coordsize="',x*f,",",x*m,'"',' coordorigin="0,0"',' style="width:',f,"px;height:",m,"px;position:absolute;"),1!=this.m_[0][0]||this.m_[0][1]){var v=[];v.push("M11=",this.m_[0][0],",","M12=",this.m_[1][0],",","M21=",this.m_[0][1],",","M22=",this.m_[1][1],",","Dx=",y(g.x/x),",","Dy=",y(g.y/x),"");var S=g,w=this.getCoords_(e+r,i),C=this.getCoords_(e,i+s),b=this.getCoords_(e+r,i+s);S.x=p.max(S.x,w.x,C.x,b.x),S.y=p.max(S.y,w.y,C.y,b.y),d.push("padding:0 ",y(S.x/x),"px ",y(S.y/x),"px 0;filter:progid:DXImageTransform.Microsoft.Matrix(",v.join(""),", sizingmethod='clip');")}else d.push("top:",y(g.y/x),"px;left:",y(g.x/x),"px;");d.push(' ">','<g_vml_:image src="',t.src,'"',' style="width:',x*r,"px;"," height:",x*s,'px;"',' cropleft="',n/u,'"',' croptop="',a/_,'"',' cropright="',(u-n-o)/u,'"',' cropbottom="',(_-a-h)/_,'"'," />","</g_vml_:group>"),this.element_.insertAdjacentHTML("BeforeEnd",d.join(""))},P.stroke=function(t){var e=[],i=o(t?this.fillStyle:this.strokeStyle),r=i.color,s=i.alpha*this.globalAlpha,n=10,a=10;e.push("<g_vml_:shape",' filled="',!!t,'"',' style="position:absolute;width:',n,"px;height:",a,'px;"',' coordorigin="0 0" coordsize="',x*n," ",x*a,'"',' stroked="',!t,'"',' path="');for(var l={x:null,y:null},c={x:null,y:null},u=0;u<this.currentPath_.length;u++){var _,g=this.currentPath_[u];switch(g.type){case"moveTo":_=g,e.push(" m ",y(g.x),",",y(g.y));break;case"lineTo":e.push(" l ",y(g.x),",",y(g.y));break;case"close":e.push(" x "),g=null;break;case"bezierCurveTo":e.push(" c ",y(g.cp1x),",",y(g.cp1y),",",y(g.cp2x),",",y(g.cp2y),",",y(g.x),",",y(g.y));break;case"at":case"wa":e.push(" ",g.type," ",y(g.x-this.arcScaleX_*g.radius),",",y(g.y-this.arcScaleY_*g.radius)," ",y(g.x+this.arcScaleX_*g.radius),",",y(g.y+this.arcScaleY_*g.radius)," ",y(g.xStart),",",y(g.yStart)," ",y(g.xEnd),",",y(g.yEnd))}g&&((null==l.x||g.x<l.x)&&(l.x=g.x),(null==c.x||g.x>c.x)&&(c.x=g.x),(null==l.y||g.y<l.y)&&(l.y=g.y),(null==c.y||g.y>c.y)&&(c.y=g.y))}if(e.push(' ">'),t)if("object"==typeof this.fillStyle){var d=this.fillStyle,f=0,m={x:0,y:0},v=0,S=1;if("gradient"==d.type_){var w=d.x0_/this.arcScaleX_,C=d.y0_/this.arcScaleY_,b=d.x1_/this.arcScaleX_,T=d.y1_/this.arcScaleY_,P=this.getCoords_(w,C),k=this.getCoords_(b,T),E=k.x-P.x,M=k.y-P.y;f=180*Math.atan2(E,M)/Math.PI,0>f&&(f+=360),1e-6>f&&(f=0)}else{var P=this.getCoords_(d.x0_,d.y0_),X=c.x-l.x,Y=c.y-l.y;m={x:(P.x-l.x)/X,y:(P.y-l.y)/Y},X/=this.arcScaleX_*x,Y/=this.arcScaleY_*x;var L=p.max(X,Y);v=2*d.r0_/L,S=2*d.r1_/L-v}var A=d.colors_;A.sort(function(t,e){return t.offset-e.offset});for(var j=A.length,V=A[0].color,z=A[j-1].color,H=A[0].alpha*this.globalAlpha,R=A[j-1].alpha*this.globalAlpha,W=[],u=0;j>u;u++){var O=A[u];W.push(O.offset*S+v+" "+O.color)}e.push('<g_vml_:fill type="',d.type_,'"',' method="none" focus="100%"',' color="',V,'"',' color2="',z,'"',' colors="',W.join(","),'"',' opacity="',R,'"',' g_o_:opacity2="',H,'"',' angle="',f,'"',' focusposition="',m.x,",",m.y,'" />')}else e.push('<g_vml_:fill color="',r,'" opacity="',s,'" />');else{var D=this.lineScale_*this.lineWidth;1>D&&(s*=D),e.push("<g_vml_:stroke",' opacity="',s,'"',' joinstyle="',this.lineJoin,'"',' miterlimit="',this.miterLimit,'"',' endcap="',h(this.lineCap),'"',' weight="',D,'px"',' color="',r,'" />')}e.push("</g_vml_:shape>"),this.element_.insertAdjacentHTML("beforeEnd",e.join(""))},P.fill=function(){this.stroke(!0)},P.closePath=function(){this.currentPath_.push({type:"close"})},P.getCoords_=function(t,e){var i=this.m_;return{x:x*(t*i[0][0]+e*i[1][0]+i[2][0])-v,y:x*(t*i[0][1]+e*i[1][1]+i[2][1])-v}},P.save=function(){var t={};a(this,t),this.aStack_.push(t),this.mStack_.push(this.m_),this.m_=n(s(),this.m_)},P.restore=function(){a(this.aStack_.pop(),this),this.m_=this.mStack_.pop()},P.translate=function(t,e){var i=[[1,0,0],[0,1,0],[t,e,1]];this.m_=n(i,this.m_)},P.rotate=function(t){var e=d(t),i=g(t),r=[[e,i,0],[-i,e,0],[0,0,1]];this.m_=n(r,this.m_)},P.scale=function(t,e){this.arcScaleX_*=t,this.arcScaleY_*=e;var i=[[t,0,0],[0,e,0],[0,0,1]],r=this.m_=n(i,this.m_),s=r[0][0]*r[1][1]-r[0][1]*r[1][0];this.lineScale_=m(f(s))},P.clip=function(){},P.arcTo=function(){},P.createPattern=function(){return new _},u.prototype.addColorStop=function(t,e){e=o(e),this.colors_.push({offset:t,color:e.color,alpha:e.alpha})},G_vmlCanvasManager=w,CanvasRenderingContext2D=l,CanvasGradient=u,CanvasPattern=_}();;
/** @license
 *
 * SoundManager 2: JavaScript Sound for the Web
 * ----------------------------------------------
 * http://schillmania.com/projects/soundmanager2/
 *
 * Copyright (c) 2007, Scott Schiller. All rights reserved.
 * Code provided under the BSD License:
 * http://schillmania.com/projects/soundmanager2/license.txt
 *
 * V2.97a.20130324 ("Mahalo" Edition)
 */
(function(k,g){function U(U,ia){function V(b){return c.preferFlash&&D&&!c.ignoreFlash&&c.flash[b]!==g&&c.flash[b]}function m(b){return function(c){var d=this._s;return!d||!d._a?null:b.call(this,c)}}this.setupOptions={url:U||null,flashVersion:8,debugMode:!0,debugFlash:!1,useConsole:!0,consoleOnly:!0,waitForWindowLoad:!1,bgColor:"#ffffff",useHighPerformance:!1,flashPollingInterval:null,html5PollingInterval:null,flashLoadTimeout:1E3,wmode:null,allowScriptAccess:"always",useFlashBlock:!1,useHTML5Audio:!0,
html5Test:/^(probably|maybe)$/i,preferFlash:!0,noSWFCache:!1};this.defaultOptions={autoLoad:!1,autoPlay:!1,from:null,loops:1,onid3:null,onload:null,whileloading:null,onplay:null,onpause:null,onresume:null,whileplaying:null,onposition:null,onstop:null,onfailure:null,onfinish:null,multiShot:!0,multiShotEvents:!1,position:null,pan:0,stream:!0,to:null,type:null,usePolicyFile:!1,volume:100};this.flash9Options={isMovieStar:null,usePeakData:!1,useWaveformData:!1,useEQData:!1,onbufferchange:null,ondataerror:null};
this.movieStarOptions={bufferTime:3,serverURL:null,onconnect:null,duration:null};this.audioFormats={mp3:{type:['audio/mpeg; codecs\x3d"mp3"',"audio/mpeg","audio/mp3","audio/MPA","audio/mpa-robust"],required:!0},mp4:{related:["aac","m4a","m4b"],type:['audio/mp4; codecs\x3d"mp4a.40.2"',"audio/aac","audio/x-m4a","audio/MP4A-LATM","audio/mpeg4-generic"],required:!1},ogg:{type:["audio/ogg; codecs\x3dvorbis"],required:!1},opus:{type:["audio/ogg; codecs\x3dopus","audio/opus"],required:!1},wav:{type:['audio/wav; codecs\x3d"1"',
"audio/wav","audio/wave","audio/x-wav"],required:!1}};this.movieID="sm2-container";this.id=ia||"sm2movie";this.debugID="soundmanager-debug";this.debugURLParam=/([#?&])debug=1/i;this.versionNumber="V2.97a.20130324";this.altURL=this.movieURL=this.version=null;this.enabled=this.swfLoaded=!1;this.oMC=null;this.sounds={};this.soundIDs=[];this.didFlashBlock=this.muted=!1;this.filePattern=null;this.filePatterns={flash8:/\.mp3(\?.*)?$/i,flash9:/\.mp3(\?.*)?$/i};this.features={buffering:!1,peakData:!1,waveformData:!1,
eqData:!1,movieStar:!1};this.sandbox={};this.html5={usingFlash:null};this.flash={};this.ignoreFlash=this.html5Only=!1;var Ja,c=this,Ka=null,h=null,W,q=navigator.userAgent,ja=k.location.href.toString(),n=document,ka,La,la,l,x=[],M=!1,N=!1,r=!1,v=!1,ma=!1,O,u,na,X,oa,E,F,G,Ma,pa,Y,qa,Z,ra,H,sa,P,ta,$,I,Na,ua,Oa,va,Pa,Q=null,wa=null,y,xa,J,aa,ba,K,p,R=!1,ya=!1,Qa,Ra,Sa,ca=0,S=null,da,Ta=[],t=null,Ua,ea,T,B,za,Aa,Va,s,eb=Array.prototype.slice,z=!1,Ba,D,Ca,Wa,A,fa,ga=q.match(/(ipad|iphone|ipod)/i),Xa=
q.match(/android/i),C=q.match(/msie/i),fb=q.match(/webkit/i),Da=q.match(/safari/i)&&!q.match(/chrome/i),Ea=q.match(/opera/i),Fa=q.match(/(mobile|pre\/|xoom)/i)||ga||Xa,Ya=!ja.match(/usehtml5audio/i)&&!ja.match(/sm2\-ignorebadua/i)&&Da&&!q.match(/silk/i)&&q.match(/OS X 10_6_([3-7])/i),Ga=n.hasFocus!==g?n.hasFocus():null,ha=Da&&(n.hasFocus===g||!n.hasFocus()),Za=!ha,$a=/(mp3|mp4|mpa|m4a|m4b)/i,Ha=n.location?n.location.protocol.match(/http/i):null,ab=!Ha?"http://":"",bb=/^\s*audio\/(?:x-)?(?:mpeg4|aac|flv|mov|mp4||m4v|m4a|m4b|mp4v|3gp|3g2)\s*(?:$|;)/i,
cb="mpeg4 aac flv mov mp4 m4v f4v m4a m4b mp4v 3gp 3g2".split(" "),gb=RegExp("\\.("+cb.join("|")+")(\\?.*)?$","i");this.mimePattern=/^\s*audio\/(?:x-)?(?:mp(?:eg|3))\s*(?:$|;)/i;this.useAltURL=!Ha;var Ia;try{Ia=Audio!==g&&(Ea&&opera!==g&&10>opera.version()?new Audio(null):new Audio).canPlayType!==g}catch(hb){Ia=!1}this.hasHTML5=Ia;this.setup=function(b){var e=!c.url;b!==g&&(r&&t&&c.ok()&&(b.flashVersion!==g||b.url!==g||b.html5Test!==g))&&K(y("setupLate"));na(b);e&&(P&&b.url!==g)&&c.beginDelayedInit();
!P&&(b.url!==g&&"complete"===n.readyState)&&setTimeout(H,1);return c};this.supported=this.ok=function(){return t?r&&!v:c.useHTML5Audio&&c.hasHTML5};this.getMovie=function(b){return W(b)||n[b]||k[b]};this.createSound=function(b,e){function d(){a=aa(a);c.sounds[a.id]=new Ja(a);c.soundIDs.push(a.id);return c.sounds[a.id]}var a,f=null;if(!r||!c.ok())return K(void 0),!1;e!==g&&(b={id:b,url:e});a=u(b);a.url=da(a.url);if(p(a.id,!0))return c.sounds[a.id];ea(a)?(f=d(),f._setup_html5(a)):(8<l&&null===a.isMovieStar&&
(a.isMovieStar=!(!a.serverURL&&!(a.type&&a.type.match(bb)||a.url.match(gb)))),a=ba(a,void 0),f=d(),8===l?h._createSound(a.id,a.loops||1,a.usePolicyFile):(h._createSound(a.id,a.url,a.usePeakData,a.useWaveformData,a.useEQData,a.isMovieStar,a.isMovieStar?a.bufferTime:!1,a.loops||1,a.serverURL,a.duration||null,a.autoPlay,!0,a.autoLoad,a.usePolicyFile),a.serverURL||(f.connected=!0,a.onconnect&&a.onconnect.apply(f))),!a.serverURL&&(a.autoLoad||a.autoPlay)&&f.load(a));!a.serverURL&&a.autoPlay&&f.play();
return f};this.destroySound=function(b,e){if(!p(b))return!1;var d=c.sounds[b],a;d._iO={};d.stop();d.unload();for(a=0;a<c.soundIDs.length;a++)if(c.soundIDs[a]===b){c.soundIDs.splice(a,1);break}e||d.destruct(!0);delete c.sounds[b];return!0};this.load=function(b,e){return!p(b)?!1:c.sounds[b].load(e)};this.unload=function(b){return!p(b)?!1:c.sounds[b].unload()};this.onposition=this.onPosition=function(b,e,d,a){return!p(b)?!1:c.sounds[b].onposition(e,d,a)};this.clearOnPosition=function(b,e,d){return!p(b)?
!1:c.sounds[b].clearOnPosition(e,d)};this.start=this.play=function(b,e){var d=!1;return!r||!c.ok()?(K("soundManager.play(): "+y(!r?"notReady":"notOK")),d):!p(b)?(e instanceof Object||(e={url:e}),e&&e.url&&(e.id=b,d=c.createSound(e).play()),d):c.sounds[b].play(e)};this.setPosition=function(b,e){return!p(b)?!1:c.sounds[b].setPosition(e)};this.stop=function(b){return!p(b)?!1:c.sounds[b].stop()};this.stopAll=function(){for(var b in c.sounds)c.sounds.hasOwnProperty(b)&&c.sounds[b].stop()};this.pause=function(b){return!p(b)?
!1:c.sounds[b].pause()};this.pauseAll=function(){var b;for(b=c.soundIDs.length-1;0<=b;b--)c.sounds[c.soundIDs[b]].pause()};this.resume=function(b){return!p(b)?!1:c.sounds[b].resume()};this.resumeAll=function(){var b;for(b=c.soundIDs.length-1;0<=b;b--)c.sounds[c.soundIDs[b]].resume()};this.togglePause=function(b){return!p(b)?!1:c.sounds[b].togglePause()};this.setPan=function(b,e){return!p(b)?!1:c.sounds[b].setPan(e)};this.setVolume=function(b,e){return!p(b)?!1:c.sounds[b].setVolume(e)};this.mute=function(b){var e=
0;b instanceof String&&(b=null);if(b)return!p(b)?!1:c.sounds[b].mute();for(e=c.soundIDs.length-1;0<=e;e--)c.sounds[c.soundIDs[e]].mute();return c.muted=!0};this.muteAll=function(){c.mute()};this.unmute=function(b){b instanceof String&&(b=null);if(b)return!p(b)?!1:c.sounds[b].unmute();for(b=c.soundIDs.length-1;0<=b;b--)c.sounds[c.soundIDs[b]].unmute();c.muted=!1;return!0};this.unmuteAll=function(){c.unmute()};this.toggleMute=function(b){return!p(b)?!1:c.sounds[b].toggleMute()};this.getMemoryUse=function(){var b=
0;h&&8!==l&&(b=parseInt(h._getMemoryUse(),10));return b};this.disable=function(b){var e;b===g&&(b=!1);if(v)return!1;v=!0;for(e=c.soundIDs.length-1;0<=e;e--)Oa(c.sounds[c.soundIDs[e]]);O(b);s.remove(k,"load",F);return!0};this.canPlayMIME=function(b){var e;c.hasHTML5&&(e=T({type:b}));!e&&t&&(e=b&&c.ok()?!!(8<l&&b.match(bb)||b.match(c.mimePattern)):null);return e};this.canPlayURL=function(b){var e;c.hasHTML5&&(e=T({url:b}));!e&&t&&(e=b&&c.ok()?!!b.match(c.filePattern):null);return e};this.canPlayLink=
function(b){return b.type!==g&&b.type&&c.canPlayMIME(b.type)?!0:c.canPlayURL(b.href)};this.getSoundById=function(b,e){if(!b)throw Error("soundManager.getSoundById(): sID is null/_undefined");return c.sounds[b]};this.onready=function(b,c){if("function"===typeof b)c||(c=k),oa("onready",b,c),E();else throw y("needFunction","onready");return!0};this.ontimeout=function(b,c){if("function"===typeof b)c||(c=k),oa("ontimeout",b,c),E({type:"ontimeout"});else throw y("needFunction","ontimeout");return!0};this._wD=
this._writeDebug=function(b,c){return!0};this._debug=function(){};this.reboot=function(b,e){var d,a,f;for(d=c.soundIDs.length-1;0<=d;d--)c.sounds[c.soundIDs[d]].destruct();if(h)try{C&&(wa=h.innerHTML),Q=h.parentNode.removeChild(h)}catch(g){}wa=Q=t=h=null;c.enabled=P=r=R=ya=M=N=v=z=c.swfLoaded=!1;c.soundIDs=[];c.sounds={};if(b)x=[];else for(d in x)if(x.hasOwnProperty(d)){a=0;for(f=x[d].length;a<f;a++)x[d][a].fired=!1}c.html5={usingFlash:null};c.flash={};c.html5Only=!1;c.ignoreFlash=!1;k.setTimeout(function(){ra();
e||c.beginDelayedInit()},20);return c};this.reset=function(){return c.reboot(!0,!0)};this.getMoviePercent=function(){return h&&"PercentLoaded"in h?h.PercentLoaded():null};this.beginDelayedInit=function(){ma=!0;H();setTimeout(function(){if(ya)return!1;$();Z();return ya=!0},20);G()};this.destruct=function(){c.disable(!0)};Ja=function(b){var e,d,a=this,f,w,db,L,k,n,m=!1,q=[],r=0,s,v,t=null;d=e=null;this.sID=this.id=b.id;this.url=b.url;this._iO=this.instanceOptions=this.options=u(b);this.pan=this.options.pan;
this.volume=this.options.volume;this.isHTML5=!1;this._a=null;this.id3={};this._debug=function(){};this.load=function(b){var c=null,e;b!==g?a._iO=u(b,a.options):(b=a.options,a._iO=b,t&&t!==a.url&&(a._iO.url=a.url,a.url=null));a._iO.url||(a._iO.url=a.url);a._iO.url=da(a._iO.url);e=a.instanceOptions=a._iO;if(e.url===a.url&&0!==a.readyState&&2!==a.readyState)return 3===a.readyState&&e.onload&&fa(a,function(){e.onload.apply(a,[!!a.duration])}),a;a.loaded=!1;a.readyState=1;a.playState=0;a.id3={};if(ea(e))c=
a._setup_html5(e),c._called_load||(a._html5_canplay=!1,a.url!==e.url&&(a._a.src=e.url,a.setPosition(0)),a._a.autobuffer="auto",a._a.preload="auto",a._a._called_load=!0,e.autoPlay&&a.play());else try{a.isHTML5=!1,a._iO=ba(aa(e)),e=a._iO,8===l?h._load(a.id,e.url,e.stream,e.autoPlay,e.usePolicyFile):h._load(a.id,e.url,!!e.stream,!!e.autoPlay,e.loops||1,!!e.autoLoad,e.usePolicyFile)}catch(d){I({type:"SMSOUND_LOAD_JS_EXCEPTION",fatal:!0})}a.url=e.url;return a};this.unload=function(){0!==a.readyState&&
(a.isHTML5?(L(),a._a&&(a._a.pause(),za(a._a,"about:blank"),t="about:blank")):8===l?h._unload(a.id,"about:blank"):h._unload(a.id),f());return a};this.destruct=function(b){a.isHTML5?(L(),a._a&&(a._a.pause(),za(a._a),z||db(),a._a._s=null,a._a=null)):(a._iO.onfailure=null,h._destroySound(a.id));b||c.destroySound(a.id,!0)};this.start=this.play=function(b,c){var e,d;d=!0;d=null;c=c===g?!0:c;b||(b={});a.url&&(a._iO.url=a.url);a._iO=u(a._iO,a.options);a._iO=u(b,a._iO);a._iO.url=da(a._iO.url);a.instanceOptions=
a._iO;if(a._iO.serverURL&&!a.connected)return a.getAutoPlay()||a.setAutoPlay(!0),a;ea(a._iO)&&(a._setup_html5(a._iO),k());1===a.playState&&!a.paused&&((e=a._iO.multiShot)||(d=a));if(null!==d)return d;b.url&&b.url!==a.url&&a.load(a._iO);a.loaded||(0===a.readyState?(a.isHTML5||(a._iO.autoPlay=!0),a.load(a._iO),a.instanceOptions=a._iO):2===a.readyState&&(d=a));if(null!==d)return d;!a.isHTML5&&(9===l&&0<a.position&&a.position===a.duration)&&(b.position=0);if(a.paused&&0<=a.position&&(!a._iO.serverURL||
0<a.position))a.resume();else{a._iO=u(b,a._iO);if(null!==a._iO.from&&null!==a._iO.to&&0===a.instanceCount&&0===a.playState&&!a._iO.serverURL){e=function(){a._iO=u(b,a._iO);a.play(a._iO)};if(a.isHTML5&&!a._html5_canplay)a.load({oncanplay:e}),d=!1;else if(!a.isHTML5&&!a.loaded&&(!a.readyState||2!==a.readyState))a.load({onload:e}),d=!1;if(null!==d)return d;a._iO=v()}(!a.instanceCount||a._iO.multiShotEvents||!a.isHTML5&&8<l&&!a.getAutoPlay())&&a.instanceCount++;a._iO.onposition&&0===a.playState&&n(a);
a.playState=1;a.paused=!1;a.position=a._iO.position!==g&&!isNaN(a._iO.position)?a._iO.position:0;a.isHTML5||(a._iO=ba(aa(a._iO)));a._iO.onplay&&c&&(a._iO.onplay.apply(a),m=!0);a.setVolume(a._iO.volume,!0);a.setPan(a._iO.pan,!0);a.isHTML5?(k(),d=a._setup_html5(),a.setPosition(a._iO.position),d.play()):(d=h._start(a.id,a._iO.loops||1,9===l?a.position:a.position/1E3,a._iO.multiShot||!1),9===l&&!d&&a._iO.onplayerror&&a._iO.onplayerror.apply(a))}return a};this.stop=function(b){var c=a._iO;1===a.playState&&
(a._onbufferchange(0),a._resetOnPosition(0),a.paused=!1,a.isHTML5||(a.playState=0),s(),c.to&&a.clearOnPosition(c.to),a.isHTML5?a._a&&(b=a.position,a.setPosition(0),a.position=b,a._a.pause(),a.playState=0,a._onTimer(),L()):(h._stop(a.id,b),c.serverURL&&a.unload()),a.instanceCount=0,a._iO={},c.onstop&&c.onstop.apply(a));return a};this.setAutoPlay=function(b){a._iO.autoPlay=b;a.isHTML5||(h._setAutoPlay(a.id,b),b&&!a.instanceCount&&1===a.readyState&&a.instanceCount++)};this.getAutoPlay=function(){return a._iO.autoPlay};
this.setPosition=function(b){b===g&&(b=0);var c=a.isHTML5?Math.max(b,0):Math.min(a.duration||a._iO.duration,Math.max(b,0));a.position=c;b=a.position/1E3;a._resetOnPosition(a.position);a._iO.position=c;if(a.isHTML5){if(a._a&&a._html5_canplay&&a._a.currentTime!==b)try{a._a.currentTime=b,(0===a.playState||a.paused)&&a._a.pause()}catch(e){}}else b=9===l?a.position:b,a.readyState&&2!==a.readyState&&h._setPosition(a.id,b,a.paused||!a.playState,a._iO.multiShot);a.isHTML5&&a.paused&&a._onTimer(!0);return a};
this.pause=function(b){if(a.paused||0===a.playState&&1!==a.readyState)return a;a.paused=!0;a.isHTML5?(a._setup_html5().pause(),L()):(b||b===g)&&h._pause(a.id,a._iO.multiShot);a._iO.onpause&&a._iO.onpause.apply(a);return a};this.resume=function(){var b=a._iO;if(!a.paused)return a;a.paused=!1;a.playState=1;a.isHTML5?(a._setup_html5().play(),k()):(b.isMovieStar&&!b.serverURL&&a.setPosition(a.position),h._pause(a.id,b.multiShot));!m&&b.onplay?(b.onplay.apply(a),m=!0):b.onresume&&b.onresume.apply(a);return a};
this.togglePause=function(){if(0===a.playState)return a.play({position:9===l&&!a.isHTML5?a.position:a.position/1E3}),a;a.paused?a.resume():a.pause();return a};this.setPan=function(b,c){b===g&&(b=0);c===g&&(c=!1);a.isHTML5||h._setPan(a.id,b);a._iO.pan=b;c||(a.pan=b,a.options.pan=b);return a};this.setVolume=function(b,e){b===g&&(b=100);e===g&&(e=!1);a.isHTML5?a._a&&(a._a.volume=Math.max(0,Math.min(1,b/100))):h._setVolume(a.id,c.muted&&!a.muted||a.muted?0:b);a._iO.volume=b;e||(a.volume=b,a.options.volume=
b);return a};this.mute=function(){a.muted=!0;a.isHTML5?a._a&&(a._a.muted=!0):h._setVolume(a.id,0);return a};this.unmute=function(){a.muted=!1;var b=a._iO.volume!==g;a.isHTML5?a._a&&(a._a.muted=!1):h._setVolume(a.id,b?a._iO.volume:a.options.volume);return a};this.toggleMute=function(){return a.muted?a.unmute():a.mute()};this.onposition=this.onPosition=function(b,c,e){q.push({position:parseInt(b,10),method:c,scope:e!==g?e:a,fired:!1});return a};this.clearOnPosition=function(a,b){var c;a=parseInt(a,
10);if(isNaN(a))return!1;for(c=0;c<q.length;c++)if(a===q[c].position&&(!b||b===q[c].method))q[c].fired&&r--,q.splice(c,1)};this._processOnPosition=function(){var b,c;b=q.length;if(!b||!a.playState||r>=b)return!1;for(b-=1;0<=b;b--)c=q[b],!c.fired&&a.position>=c.position&&(c.fired=!0,r++,c.method.apply(c.scope,[c.position]));return!0};this._resetOnPosition=function(a){var b,c;b=q.length;if(!b)return!1;for(b-=1;0<=b;b--)c=q[b],c.fired&&a<=c.position&&(c.fired=!1,r--);return!0};v=function(){var b=a._iO,
c=b.from,e=b.to,d,f;f=function(){a.clearOnPosition(e,f);a.stop()};d=function(){if(null!==e&&!isNaN(e))a.onPosition(e,f)};null!==c&&!isNaN(c)&&(b.position=c,b.multiShot=!1,d());return b};n=function(){var b,c=a._iO.onposition;if(c)for(b in c)if(c.hasOwnProperty(b))a.onPosition(parseInt(b,10),c[b])};s=function(){var b,c=a._iO.onposition;if(c)for(b in c)c.hasOwnProperty(b)&&a.clearOnPosition(parseInt(b,10))};k=function(){a.isHTML5&&Qa(a)};L=function(){a.isHTML5&&Ra(a)};f=function(b){b||(q=[],r=0);m=!1;
a._hasTimer=null;a._a=null;a._html5_canplay=!1;a.bytesLoaded=null;a.bytesTotal=null;a.duration=a._iO&&a._iO.duration?a._iO.duration:null;a.durationEstimate=null;a.buffered=[];a.eqData=[];a.eqData.left=[];a.eqData.right=[];a.failures=0;a.isBuffering=!1;a.instanceOptions={};a.instanceCount=0;a.loaded=!1;a.metadata={};a.readyState=0;a.muted=!1;a.paused=!1;a.peakData={left:0,right:0};a.waveformData={left:[],right:[]};a.playState=0;a.position=null;a.id3={}};f();this._onTimer=function(b){var c,f=!1,g={};
if(a._hasTimer||b){if(a._a&&(b||(0<a.playState||1===a.readyState)&&!a.paused))c=a._get_html5_duration(),c!==e&&(e=c,a.duration=c,f=!0),a.durationEstimate=a.duration,c=1E3*a._a.currentTime||0,c!==d&&(d=c,f=!0),(f||b)&&a._whileplaying(c,g,g,g,g);return f}};this._get_html5_duration=function(){var b=a._iO;return(b=a._a&&a._a.duration?1E3*a._a.duration:b&&b.duration?b.duration:null)&&!isNaN(b)&&Infinity!==b?b:null};this._apply_loop=function(a,b){a.loop=1<b?"loop":""};this._setup_html5=function(b){b=u(a._iO,
b);var c=z?Ka:a._a,e=decodeURI(b.url),d;z?e===decodeURI(Ba)&&(d=!0):e===decodeURI(t)&&(d=!0);if(c){if(c._s)if(z)c._s&&(c._s.playState&&!d)&&c._s.stop();else if(!z&&e===decodeURI(t))return a._apply_loop(c,b.loops),c;d||(f(!1),c.src=b.url,Ba=t=a.url=b.url,c._called_load=!1)}else a._a=b.autoLoad||b.autoPlay?new Audio(b.url):Ea&&10>opera.version()?new Audio(null):new Audio,c=a._a,c._called_load=!1,z&&(Ka=c);a.isHTML5=!0;a._a=c;c._s=a;w();a._apply_loop(c,b.loops);b.autoLoad||b.autoPlay?a.load():(c.autobuffer=
!1,c.preload="auto");return c};w=function(){if(a._a._added_events)return!1;var b;a._a._added_events=!0;for(b in A)A.hasOwnProperty(b)&&a._a&&a._a.addEventListener(b,A[b],!1);return!0};db=function(){var b;a._a._added_events=!1;for(b in A)A.hasOwnProperty(b)&&a._a&&a._a.removeEventListener(b,A[b],!1)};this._onload=function(b){var c=!!b||!a.isHTML5&&8===l&&a.duration;a.loaded=c;a.readyState=c?3:2;a._onbufferchange(0);a._iO.onload&&fa(a,function(){a._iO.onload.apply(a,[c])});return!0};this._onbufferchange=
function(b){if(0===a.playState||b&&a.isBuffering||!b&&!a.isBuffering)return!1;a.isBuffering=1===b;a._iO.onbufferchange&&a._iO.onbufferchange.apply(a);return!0};this._onsuspend=function(){a._iO.onsuspend&&a._iO.onsuspend.apply(a);return!0};this._onfailure=function(b,c,e){a.failures++;if(a._iO.onfailure&&1===a.failures)a._iO.onfailure(a,b,c,e)};this._onfinish=function(){var b=a._iO.onfinish;a._onbufferchange(0);a._resetOnPosition(0);a.instanceCount&&(a.instanceCount--,a.instanceCount||(s(),a.playState=
0,a.paused=!1,a.instanceCount=0,a.instanceOptions={},a._iO={},L(),a.isHTML5&&(a.position=0)),(!a.instanceCount||a._iO.multiShotEvents)&&b&&fa(a,function(){b.apply(a)}))};this._whileloading=function(b,c,e,d){var f=a._iO;a.bytesLoaded=b;a.bytesTotal=c;a.duration=Math.floor(e);a.bufferLength=d;a.durationEstimate=!a.isHTML5&&!f.isMovieStar?f.duration?a.duration>f.duration?a.duration:f.duration:parseInt(a.bytesTotal/a.bytesLoaded*a.duration,10):a.duration;a.isHTML5||(a.buffered=[{start:0,end:a.duration}]);
(3!==a.readyState||a.isHTML5)&&f.whileloading&&f.whileloading.apply(a)};this._whileplaying=function(b,c,e,d,f){var w=a._iO;if(isNaN(b)||null===b)return!1;a.position=Math.max(0,b);a._processOnPosition();!a.isHTML5&&8<l&&(w.usePeakData&&(c!==g&&c)&&(a.peakData={left:c.leftPeak,right:c.rightPeak}),w.useWaveformData&&(e!==g&&e)&&(a.waveformData={left:e.split(","),right:d.split(",")}),w.useEQData&&(f!==g&&f&&f.leftEQ)&&(b=f.leftEQ.split(","),a.eqData=b,a.eqData.left=b,f.rightEQ!==g&&f.rightEQ&&(a.eqData.right=
f.rightEQ.split(","))));1===a.playState&&(!a.isHTML5&&(8===l&&!a.position&&a.isBuffering)&&a._onbufferchange(0),w.whileplaying&&w.whileplaying.apply(a));return!0};this._oncaptiondata=function(b){a.captiondata=b;a._iO.oncaptiondata&&a._iO.oncaptiondata.apply(a,[b])};this._onmetadata=function(b,c){var e={},d,f;d=0;for(f=b.length;d<f;d++)e[b[d]]=c[d];a.metadata=e;a._iO.onmetadata&&a._iO.onmetadata.apply(a)};this._onid3=function(b,c){var e=[],d,f;d=0;for(f=b.length;d<f;d++)e[b[d]]=c[d];a.id3=u(a.id3,
e);a._iO.onid3&&a._iO.onid3.apply(a)};this._onconnect=function(b){b=1===b;if(a.connected=b)a.failures=0,p(a.id)&&(a.getAutoPlay()?a.play(g,a.getAutoPlay()):a._iO.autoLoad&&a.load()),a._iO.onconnect&&a._iO.onconnect.apply(a,[b])};this._ondataerror=function(b){0<a.playState&&a._iO.ondataerror&&a._iO.ondataerror.apply(a)}};ta=function(){return n.body||n._docElement||n.getElementsByTagName("div")[0]};W=function(b){return n.getElementById(b)};u=function(b,e){var d=b||{},a,f;a=e===g?c.defaultOptions:e;
for(f in a)a.hasOwnProperty(f)&&d[f]===g&&(d[f]="object"!==typeof a[f]||null===a[f]?a[f]:u(d[f],a[f]));return d};fa=function(b,c){!b.isHTML5&&8===l?k.setTimeout(c,0):c()};X={onready:1,ontimeout:1,defaultOptions:1,flash9Options:1,movieStarOptions:1};na=function(b,e){var d,a=!0,f=e!==g,w=c.setupOptions;for(d in b)if(b.hasOwnProperty(d))if("object"!==typeof b[d]||null===b[d]||b[d]instanceof Array||b[d]instanceof RegExp)f&&X[e]!==g?c[e][d]=b[d]:w[d]!==g?(c.setupOptions[d]=b[d],c[d]=b[d]):X[d]===g?(K(y(c[d]===
g?"setupUndef":"setupError",d),2),a=!1):c[d]instanceof Function?c[d].apply(c,b[d]instanceof Array?b[d]:[b[d]]):c[d]=b[d];else if(X[d]===g)K(y(c[d]===g?"setupUndef":"setupError",d),2),a=!1;else return na(b[d],d);return a};s=function(){function b(a){a=eb.call(a);var b=a.length;d?(a[1]="on"+a[1],3<b&&a.pop()):3===b&&a.push(!1);return a}function c(b,e){var g=b.shift(),h=[a[e]];if(d)g[h](b[0],b[1]);else g[h].apply(g,b)}var d=k.attachEvent,a={add:d?"attachEvent":"addEventListener",remove:d?"detachEvent":
"removeEventListener"};return{add:function(){c(b(arguments),"add")},remove:function(){c(b(arguments),"remove")}}}();A={abort:m(function(){}),canplay:m(function(){var b=this._s,c;if(b._html5_canplay)return!0;b._html5_canplay=!0;b._onbufferchange(0);c=b._iO.position!==g&&!isNaN(b._iO.position)?b._iO.position/1E3:null;if(b.position&&this.currentTime!==c)try{this.currentTime=c}catch(d){}b._iO._oncanplay&&b._iO._oncanplay()}),canplaythrough:m(function(){var b=this._s;b.loaded||(b._onbufferchange(0),b._whileloading(b.bytesLoaded,
b.bytesTotal,b._get_html5_duration()),b._onload(!0))}),ended:m(function(){this._s._onfinish()}),error:m(function(){this._s._onload(!1)}),loadeddata:m(function(){var b=this._s;!b._loaded&&!Da&&(b.duration=b._get_html5_duration())}),loadedmetadata:m(function(){}),loadstart:m(function(){this._s._onbufferchange(1)}),play:m(function(){this._s._onbufferchange(0)}),playing:m(function(){this._s._onbufferchange(0)}),progress:m(function(b){var c=this._s,d,a,f=0,f=b.target.buffered;d=b.loaded||0;var g=b.total||
1;c.buffered=[];if(f&&f.length){d=0;for(a=f.length;d<a;d++)c.buffered.push({start:1E3*f.start(d),end:1E3*f.end(d)});f=1E3*(f.end(0)-f.start(0));d=f/(1E3*b.target.duration)}isNaN(d)||(c._onbufferchange(0),c._whileloading(d,g,c._get_html5_duration()),d&&(g&&d===g)&&A.canplaythrough.call(this,b))}),ratechange:m(function(){}),suspend:m(function(b){var c=this._s;A.progress.call(this,b);c._onsuspend()}),stalled:m(function(){}),timeupdate:m(function(){this._s._onTimer()}),waiting:m(function(){this._s._onbufferchange(1)})};
ea=function(b){return b.serverURL||b.type&&V(b.type)?!1:b.type?T({type:b.type}):T({url:b.url})||c.html5Only};za=function(b,c){b&&(b.src=c,b._called_load=!1);z&&(Ba=null)};T=function(b){if(!c.useHTML5Audio||!c.hasHTML5)return!1;var e=b.url||null;b=b.type||null;var d=c.audioFormats,a;if(b&&c.html5[b]!==g)return c.html5[b]&&!V(b);if(!B){B=[];for(a in d)d.hasOwnProperty(a)&&(B.push(a),d[a].related&&(B=B.concat(d[a].related)));B=RegExp("\\.("+B.join("|")+")(\\?.*)?$","i")}a=e?e.toLowerCase().match(B):
null;!a||!a.length?b&&(e=b.indexOf(";"),a=(-1!==e?b.substr(0,e):b).substr(6)):a=a[1];a&&c.html5[a]!==g?e=c.html5[a]&&!V(a):(b="audio/"+a,e=c.html5.canPlayType({type:b}),e=(c.html5[a]=e)&&c.html5[b]&&!V(b));return e};Va=function(){function b(a){var b,d,f=b=!1;if(!e||"function"!==typeof e.canPlayType)return b;if(a instanceof Array){b=0;for(d=a.length;b<d;b++)if(c.html5[a[b]]||e.canPlayType(a[b]).match(c.html5Test))f=!0,c.html5[a[b]]=!0,c.flash[a[b]]=!!a[b].match($a);b=f}else a=e&&"function"===typeof e.canPlayType?
e.canPlayType(a):!1,b=!(!a||!a.match(c.html5Test));return b}if(!c.useHTML5Audio||!c.hasHTML5)return!1;var e=Audio!==g?Ea&&10>opera.version()?new Audio(null):new Audio:null,d,a,f={},h;h=c.audioFormats;for(d in h)if(h.hasOwnProperty(d)&&(a="audio/"+d,f[d]=b(h[d].type),f[a]=f[d],d.match($a)?(c.flash[d]=!0,c.flash[a]=!0):(c.flash[d]=!1,c.flash[a]=!1),h[d]&&h[d].related))for(a=h[d].related.length-1;0<=a;a--)f["audio/"+h[d].related[a]]=f[d],c.html5[h[d].related[a]]=f[d],c.flash[h[d].related[a]]=f[d];f.canPlayType=
e?b:null;c.html5=u(c.html5,f);return!0};qa={};y=function(){};aa=function(b){8===l&&(1<b.loops&&b.stream)&&(b.stream=!1);return b};ba=function(b,c){if(b&&!b.usePolicyFile&&(b.onid3||b.usePeakData||b.useWaveformData||b.useEQData))b.usePolicyFile=!0;return b};K=function(b){};ka=function(){return!1};Oa=function(b){for(var c in b)b.hasOwnProperty(c)&&"function"===typeof b[c]&&(b[c]=ka)};va=function(b){b===g&&(b=!1);(v||b)&&c.disable(b)};Pa=function(b){var e=null;if(b)if(b.match(/\.swf(\?.*)?$/i)){if(e=
b.substr(b.toLowerCase().lastIndexOf(".swf?")+4))return b}else b.lastIndexOf("/")!==b.length-1&&(b+="/");b=(b&&-1!==b.lastIndexOf("/")?b.substr(0,b.lastIndexOf("/")+1):"./")+c.movieURL;c.noSWFCache&&(b+="?ts\x3d"+(new Date).getTime());return b};pa=function(){l=parseInt(c.flashVersion,10);8!==l&&9!==l&&(c.flashVersion=l=8);var b=c.debugMode||c.debugFlash?"_debug.swf":".swf";c.useHTML5Audio&&(!c.html5Only&&c.audioFormats.mp4.required&&9>l)&&(c.flashVersion=l=9);c.version=c.versionNumber+(c.html5Only?
" (HTML5-only mode)":9===l?" (AS3/Flash 9)":" (AS2/Flash 8)");8<l?(c.defaultOptions=u(c.defaultOptions,c.flash9Options),c.features.buffering=!0,c.defaultOptions=u(c.defaultOptions,c.movieStarOptions),c.filePatterns.flash9=RegExp("\\.(mp3|"+cb.join("|")+")(\\?.*)?$","i"),c.features.movieStar=!0):c.features.movieStar=!1;c.filePattern=c.filePatterns[8!==l?"flash9":"flash8"];c.movieURL=(8===l?"soundmanager2.swf":"soundmanager2_flash9.swf").replace(".swf",b);c.features.peakData=c.features.waveformData=
c.features.eqData=8<l};Na=function(b,c){if(!h)return!1;h._setPolling(b,c)};ua=function(){c.debugURLParam.test(ja)&&(c.debugMode=!0)};p=this.getSoundById;J=function(){var b=[];c.debugMode&&b.push("sm2_debug");c.debugFlash&&b.push("flash_debug");c.useHighPerformance&&b.push("high_performance");return b.join(" ")};xa=function(){y("fbHandler");var b=c.getMoviePercent(),e={type:"FLASHBLOCK"};if(c.html5Only)return!1;c.ok()?c.oMC&&(c.oMC.className=[J(),"movieContainer","swf_loaded"+(c.didFlashBlock?" swf_unblocked":
"")].join(" ")):(t&&(c.oMC.className=J()+" movieContainer "+(null===b?"swf_timedout":"swf_error")),c.didFlashBlock=!0,E({type:"ontimeout",ignoreInit:!0,error:e}),I(e))};oa=function(b,c,d){x[b]===g&&(x[b]=[]);x[b].push({method:c,scope:d||null,fired:!1})};E=function(b){b||(b={type:c.ok()?"onready":"ontimeout"});if(!r&&b&&!b.ignoreInit||"ontimeout"===b.type&&(c.ok()||v&&!b.ignoreInit))return!1;var e={success:b&&b.ignoreInit?c.ok():!v},d=b&&b.type?x[b.type]||[]:[],a=[],f,e=[e],g=t&&!c.ok();b.error&&(e[0].error=
b.error);b=0;for(f=d.length;b<f;b++)!0!==d[b].fired&&a.push(d[b]);if(a.length){b=0;for(f=a.length;b<f;b++)a[b].scope?a[b].method.apply(a[b].scope,e):a[b].method.apply(this,e),g||(a[b].fired=!0)}return!0};F=function(){k.setTimeout(function(){c.useFlashBlock&&xa();E();"function"===typeof c.onload&&c.onload.apply(k);c.waitForWindowLoad&&s.add(k,"load",F)},1)};Ca=function(){if(D!==g)return D;var b=!1,c=navigator,d=c.plugins,a,f=k.ActiveXObject;if(d&&d.length)(c=c.mimeTypes)&&(c["application/x-shockwave-flash"]&&
c["application/x-shockwave-flash"].enabledPlugin&&c["application/x-shockwave-flash"].enabledPlugin.description)&&(b=!0);else if(f!==g&&!q.match(/MSAppHost/i)){try{a=new f("ShockwaveFlash.ShockwaveFlash")}catch(h){}b=!!a}return D=b};Ua=function(){var b,e,d=c.audioFormats;if(ga&&q.match(/os (1|2|3_0|3_1)/i))c.hasHTML5=!1,c.html5Only=!0,c.oMC&&(c.oMC.style.display="none");else if(c.useHTML5Audio&&(!c.html5||!c.html5.canPlayType))c.hasHTML5=!1;if(c.useHTML5Audio&&c.hasHTML5)for(e in d)if(d.hasOwnProperty(e)&&
(d[e].required&&!c.html5.canPlayType(d[e].type)||c.preferFlash&&(c.flash[e]||c.flash[d[e].type])))b=!0;c.ignoreFlash&&(b=!1);c.html5Only=c.hasHTML5&&c.useHTML5Audio&&!b;return!c.html5Only};da=function(b){var e,d,a=0;if(b instanceof Array){e=0;for(d=b.length;e<d;e++)if(b[e]instanceof Object){if(c.canPlayMIME(b[e].type)){a=e;break}}else if(c.canPlayURL(b[e])){a=e;break}b[a].url&&(b[a]=b[a].url);b=b[a]}return b};Qa=function(b){b._hasTimer||(b._hasTimer=!0,!Fa&&c.html5PollingInterval&&(null===S&&0===
ca&&(S=setInterval(Sa,c.html5PollingInterval)),ca++))};Ra=function(b){b._hasTimer&&(b._hasTimer=!1,!Fa&&c.html5PollingInterval&&ca--)};Sa=function(){var b;if(null!==S&&!ca)return clearInterval(S),S=null,!1;for(b=c.soundIDs.length-1;0<=b;b--)c.sounds[c.soundIDs[b]].isHTML5&&c.sounds[c.soundIDs[b]]._hasTimer&&c.sounds[c.soundIDs[b]]._onTimer()};I=function(b){b=b!==g?b:{};"function"===typeof c.onerror&&c.onerror.apply(k,[{type:b.type!==g?b.type:null}]);b.fatal!==g&&b.fatal&&c.disable()};Wa=function(){if(!Ya||
!Ca())return!1;var b=c.audioFormats,e,d;for(d in b)if(b.hasOwnProperty(d)&&("mp3"===d||"mp4"===d))if(c.html5[d]=!1,b[d]&&b[d].related)for(e=b[d].related.length-1;0<=e;e--)c.html5[b[d].related[e]]=!1};this._setSandboxType=function(b){};this._externalInterfaceOK=function(b,e){if(c.swfLoaded)return!1;c.swfLoaded=!0;ha=!1;Ya&&Wa();setTimeout(la,C?100:1)};$=function(b,e){function d(a,b){return'\x3cparam name\x3d"'+a+'" value\x3d"'+b+'" /\x3e'}if(M&&N)return!1;if(c.html5Only)return pa(),c.oMC=W(c.movieID),
la(),N=M=!0,!1;var a=e||c.url,f=c.altURL||a,h=ta(),k=J(),l=null,l=n.getElementsByTagName("html")[0],m,r,p,l=l&&l.dir&&l.dir.match(/rtl/i);b=b===g?c.id:b;pa();c.url=Pa(Ha?a:f);e=c.url;c.wmode=!c.wmode&&c.useHighPerformance?"transparent":c.wmode;if(null!==c.wmode&&(q.match(/msie 8/i)||!C&&!c.useHighPerformance)&&navigator.platform.match(/win32|win64/i))Ta.push(qa.spcWmode),c.wmode=null;h={name:b,id:b,src:e,quality:"high",allowScriptAccess:c.allowScriptAccess,bgcolor:c.bgColor,pluginspage:ab+"www.macromedia.com/go/getflashplayer",
title:"JS/Flash audio component (SoundManager 2)",type:"application/x-shockwave-flash",wmode:c.wmode,hasPriority:"true"};c.debugFlash&&(h.FlashVars="debug\x3d1");c.wmode||delete h.wmode;if(C)a=n.createElement("div"),r=['\x3cobject id\x3d"'+b+'" data\x3d"'+e+'" type\x3d"'+h.type+'" title\x3d"'+h.title+'" classid\x3d"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase\x3d"'+ab+'download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version\x3d6,0,40,0"\x3e',d("movie",e),d("AllowScriptAccess",
c.allowScriptAccess),d("quality",h.quality),c.wmode?d("wmode",c.wmode):"",d("bgcolor",c.bgColor),d("hasPriority","true"),c.debugFlash?d("FlashVars",h.FlashVars):"","\x3c/object\x3e"].join("");else for(m in a=n.createElement("embed"),h)h.hasOwnProperty(m)&&a.setAttribute(m,h[m]);ua();k=J();if(h=ta())if(c.oMC=W(c.movieID)||n.createElement("div"),c.oMC.id)p=c.oMC.className,c.oMC.className=(p?p+" ":"movieContainer")+(k?" "+k:""),c.oMC.appendChild(a),C&&(m=c.oMC.appendChild(n.createElement("div")),m.className=
"sm2-object-box",m.innerHTML=r),N=!0;else{c.oMC.id=c.movieID;c.oMC.className="movieContainer "+k;m=k=null;c.useFlashBlock||(c.useHighPerformance?k={position:"fixed",width:"8px",height:"8px",bottom:"0px",left:"0px",overflow:"hidden"}:(k={position:"absolute",width:"6px",height:"6px",top:"-9999px",left:"-9999px"},l&&(k.left=Math.abs(parseInt(k.left,10))+"px")));fb&&(c.oMC.style.zIndex=1E4);if(!c.debugFlash)for(p in k)k.hasOwnProperty(p)&&(c.oMC.style[p]=k[p]);try{C||c.oMC.appendChild(a),h.appendChild(c.oMC),
C&&(m=c.oMC.appendChild(n.createElement("div")),m.className="sm2-object-box",m.innerHTML=r),N=!0}catch(s){throw Error(y("domError")+" \n"+s.toString());}}return M=!0};Z=function(){if(c.html5Only)return $(),!1;if(h||!c.url)return!1;h=c.getMovie(c.id);h||(Q?(C?c.oMC.innerHTML=wa:c.oMC.appendChild(Q),Q=null,M=!0):$(c.id,c.url),h=c.getMovie(c.id));"function"===typeof c.oninitmovie&&setTimeout(c.oninitmovie,1);return!0};G=function(){setTimeout(Ma,1E3)};Ma=function(){var b,e=!1;if(!c.url||R)return!1;R=
!0;s.remove(k,"load",G);if(ha&&!Ga)return!1;r||(b=c.getMoviePercent(),0<b&&100>b&&(e=!0));setTimeout(function(){b=c.getMoviePercent();if(e)return R=!1,k.setTimeout(G,1),!1;!r&&Za&&(null===b?c.useFlashBlock||0===c.flashLoadTimeout?c.useFlashBlock&&xa():E({type:"ontimeout",ignoreInit:!0}):0!==c.flashLoadTimeout&&va(!0))},c.flashLoadTimeout)};Y=function(){if(Ga||!ha)return s.remove(k,"focus",Y),!0;Ga=Za=!0;R=!1;G();s.remove(k,"focus",Y);return!0};O=function(b){if(r)return!1;if(c.html5Only)return r=!0,
F(),!0;var e=!0,d;if(!c.useFlashBlock||!c.flashLoadTimeout||c.getMoviePercent())r=!0,v&&(d={type:!D&&t?"NO_FLASH":"INIT_TIMEOUT"});if(v||b)c.useFlashBlock&&c.oMC&&(c.oMC.className=J()+" "+(null===c.getMoviePercent()?"swf_timedout":"swf_error")),E({type:"ontimeout",error:d,ignoreInit:!0}),I(d),e=!1;v||(c.waitForWindowLoad&&!ma?s.add(k,"load",F):F());return e};La=function(){var b,e=c.setupOptions;for(b in e)e.hasOwnProperty(b)&&(c[b]===g?c[b]=e[b]:c[b]!==e[b]&&(c.setupOptions[b]=c[b]))};la=function(){if(r)return!1;
if(c.html5Only)return r||(s.remove(k,"load",c.beginDelayedInit),c.enabled=!0,O()),!0;Z();try{h._externalInterfaceTest(!1),Na(!0,c.flashPollingInterval||(c.useHighPerformance?10:50)),c.debugMode||h._disableDebug(),c.enabled=!0,c.html5Only||s.add(k,"unload",ka)}catch(b){return I({type:"JS_TO_FLASH_EXCEPTION",fatal:!0}),va(!0),O(),!1}O();s.remove(k,"load",c.beginDelayedInit);return!0};H=function(){if(P)return!1;P=!0;La();ua();!D&&c.hasHTML5&&c.setup({useHTML5Audio:!0,preferFlash:!1});Va();c.html5.usingFlash=
Ua();t=c.html5.usingFlash;!D&&t&&(Ta.push(qa.needFlash),c.setup({flashLoadTimeout:1}));n.removeEventListener&&n.removeEventListener("DOMContentLoaded",H,!1);Z();return!0};Aa=function(){"complete"===n.readyState&&(H(),n.detachEvent("onreadystatechange",Aa));return!0};sa=function(){ma=!0;s.remove(k,"load",sa)};ra=function(){if(Fa&&(c.setupOptions.useHTML5Audio=!0,c.setupOptions.preferFlash=!1,ga||Xa&&!q.match(/android\s2\.3/i)))ga&&(c.ignoreFlash=!0),z=!0};ra();Ca();s.add(k,"focus",Y);s.add(k,"load",
G);s.add(k,"load",sa);n.addEventListener?n.addEventListener("DOMContentLoaded",H,!1):n.attachEvent?n.attachEvent("onreadystatechange",Aa):I({type:"NO_DOM2_EVENTS",fatal:!0})}var ia=null;if(void 0===k.SM2_DEFER||!SM2_DEFER)ia=new U;k.SoundManager=U;k.soundManager=ia})(window);;
function Animator(t){this.setOptions(t);var e=this;this.timerDelegate=function(){e.onTimerEvent()},this.subjects=[],this.subjectScopes=[],this.target=0,this.state=0,this.lastTime=null}function NumericalStyleSubject(t,e,i,r,o){this.els=Animator.makeArray(t),this.property="opacity"==e&&window.ActiveXObject?"filter":Animator.camelize(e),this.from=parseFloat(i),this.to=parseFloat(r),this.units=null!=o?o:"px"}function ColorStyleSubject(t,e,i,r){this.els=Animator.makeArray(t),this.property=Animator.camelize(e),this.to=this.expandColor(r),this.from=this.expandColor(i),this.origFrom=i,this.origTo=r}function DiscreteStyleSubject(t,e,i,r,o){this.els=Animator.makeArray(t),this.property=Animator.camelize(e),this.from=i,this.to=r,this.threshold=o||.5}function CSSStyleSubject(t,e,i){if(t=Animator.makeArray(t),this.subjects=[],0!=t.length){var r,o,s;if(i)s=this.parseStyle(e,t[0]),o=this.parseStyle(i,t[0]);else{o=this.parseStyle(e,t[0]),s={};for(r in o)s[r]=CSSStyleSubject.getStyle(t[0],r)}var r;for(r in s)s[r]==o[r]&&(delete s[r],delete o[r]);var r,n,a,l,h,c;for(r in s){var u=String(s[r]),p=String(o[r]);if(null!=o[r]){if(h=ColorStyleSubject.parseColor(u))c=ColorStyleSubject.parseColor(p),l=ColorStyleSubject;else if(u.match(CSSStyleSubject.numericalRe)&&p.match(CSSStyleSubject.numericalRe)){h=parseFloat(u),c=parseFloat(p),l=NumericalStyleSubject,a=CSSStyleSubject.numericalRe.exec(u);var m=CSSStyleSubject.numericalRe.exec(p);n=null!=a[1]?a[1]:null!=m[1]?m[1]:m}else{if(!u.match(CSSStyleSubject.discreteRe)||!p.match(CSSStyleSubject.discreteRe)){window.DEBUG&&alert("Unrecognised format for value of "+r+": '"+s[r]+"'");continue}h=u,c=p,l=DiscreteStyleSubject,n=0}this.subjects[this.subjects.length]=new l(t,r,h,c,n)}else window.DEBUG&&alert("No to style provided for '"+r+'"')}}}function AnimatorChain(t,e){this.animators=t,this.setOptions(e);for(var i=0;i<this.animators.length;i++)this.listenTo(this.animators[i]);this.forwards=!1,this.current=0}function Accordion(t){this.setOptions(t);var e,i=this.options.initialSection;this.options.rememberance&&(e=document.location.hash.substring(1)),this.rememberanceTexts=[],this.ans=[];for(var r=this,o=0;o<this.options.sections.length;o++){var s=this.options.sections[o],n=new Animator(this.options.animatorOptions),a=this.options.from+this.options.shift*o,l=this.options.to+this.options.shift*o;n.addSubject(new NumericalStyleSubject(s,this.options.property,a,l,this.options.units)),n.jumpTo(0);var h=this.options.getActivator(s);h.index=o,h.onclick=function(){r.show(this.index)},this.ans[this.ans.length]=n,this.rememberanceTexts[o]=h.innerHTML.replace(/\s/g,""),this.rememberanceTexts[o]===e&&(i=o)}this.show(i)}Animator.prototype={setOptions:function(t){this.options=Animator.applyDefaults({interval:20,duration:400,onComplete:function(){},onStep:function(){},transition:Animator.tx.easeInOut},t)},seekTo:function(t){this.seekFromTo(this.state,t)},seekFromTo:function(t,e){this.target=Math.max(0,Math.min(1,e)),this.state=Math.max(0,Math.min(1,t)),this.lastTime=(new Date).getTime(),this.intervalId||(this.intervalId=window.setInterval(this.timerDelegate,this.options.interval))},jumpTo:function(t){this.target=this.state=Math.max(0,Math.min(1,t)),this.propagate()},toggle:function(){this.seekTo(1-this.target)},addSubject:function(t,e){return this.subjects[this.subjects.length]=t,this.subjectScopes[this.subjectScopes.length]=e,this},clearSubjects:function(){this.subjects=[],this.subjectScopes=[]},propagate:function(){for(var t=this.options.transition(this.state),e=0;e<this.subjects.length;e++)this.subjects[e].setState?this.subjects[e].setState(t):this.subjects[e].apply(this.subjectScopes[e],[t])},onTimerEvent:function(){var t=(new Date).getTime(),e=t-this.lastTime;this.lastTime=t;var i=e/this.options.duration*(this.state<this.target?1:-1);Math.abs(i)>=Math.abs(this.state-this.target)?this.state=this.target:this.state+=i;try{this.propagate()}finally{this.options.onStep.call(this),this.target==this.state&&(window.clearInterval(this.intervalId),this.intervalId=null,this.options.onComplete.call(this))}},play:function(){this.seekFromTo(0,1)},reverse:function(){this.seekFromTo(1,0)},inspect:function(){for(var t="#<Animator:\n",e=0;e<this.subjects.length;e++)t+=this.subjects[e].inspect();return t+=">"}},Animator.applyDefaults=function(t,e){e=e||{};var i,r={};for(i in t)r[i]=void 0!==e[i]?e[i]:t[i];return r},Animator.makeArray=function(t){if(null==t)return[];if(!t.length)return[t];for(var e=[],i=0;i<t.length;i++)e[i]=t[i];return e},Animator.camelize=function(t){var e=t.split("-");if(1==e.length)return e[0];for(var i=0==t.indexOf("-")?e[0].charAt(0).toUpperCase()+e[0].substring(1):e[0],r=1,o=e.length;o>r;r++){var s=e[r];i+=s.charAt(0).toUpperCase()+s.substring(1)}return i},Animator.apply=function(t,e,i){return new Animator(i).addSubject(e instanceof Array?new CSSStyleSubject(t,e[0],e[1]):new CSSStyleSubject(t,e))},Animator.makeEaseIn=function(t){return function(e){return Math.pow(e,2*t)}},Animator.makeEaseOut=function(t){return function(e){return 1-Math.pow(1-e,2*t)}},Animator.makeElastic=function(t){return function(e){return e=Animator.tx.easeInOut(e),(1-Math.cos(e*Math.PI*t))*(1-e)+e}},Animator.makeADSR=function(t,e,i,r){return null==r&&(r=.5),function(o){return t>o?o/t:e>o?1-(o-t)/(e-t)*(1-r):i>o?r:r*(1-(o-i)/(1-i))}},Animator.makeBounce=function(t){var e=Animator.makeElastic(t);return function(t){return t=e(t),1>=t?t:2-t}},Animator.tx={easeInOut:function(t){return-Math.cos(t*Math.PI)/2+.5},linear:function(t){return t},easeIn:Animator.makeEaseIn(1.5),easeOut:Animator.makeEaseOut(1.5),strongEaseIn:Animator.makeEaseIn(2.5),strongEaseOut:Animator.makeEaseOut(2.5),elastic:Animator.makeElastic(1),veryElastic:Animator.makeElastic(3),bouncy:Animator.makeBounce(1),veryBouncy:Animator.makeBounce(3)},NumericalStyleSubject.prototype={setState:function(t){for(var e=this.getStyle(t),i=("opacity"==this.property&&0==t?"hidden":"",0),r=0;r<this.els.length;r++){try{this.els[r].style[this.property]=e}catch(o){if("fontWeight"!=this.property)throw o}if(i++>20)return}},getStyle:function(t){return t=this.from+(this.to-this.from)*t,"filter"==this.property?"alpha(opacity="+Math.round(100*t)+")":"opacity"==this.property?t:Math.round(t)+this.units},inspect:function(){return"	"+this.property+"("+this.from+this.units+" to "+this.to+this.units+")\n"}},ColorStyleSubject.prototype={expandColor:function(t){var e,i,r,o;return(e=ColorStyleSubject.parseColor(t))?(i=parseInt(e.slice(1,3),16),r=parseInt(e.slice(3,5),16),o=parseInt(e.slice(5,7),16),[i,r,o]):void(window.DEBUG&&alert("Invalid colour: '"+t+"'"))},getValueForState:function(t,e){return Math.round(this.from[t]+(this.to[t]-this.from[t])*e)},setState:function(t){for(var e="#"+ColorStyleSubject.toColorPart(this.getValueForState(0,t))+ColorStyleSubject.toColorPart(this.getValueForState(1,t))+ColorStyleSubject.toColorPart(this.getValueForState(2,t)),i=0;i<this.els.length;i++)this.els[i].style[this.property]=e},inspect:function(){return"	"+this.property+"("+this.origFrom+" to "+this.origTo+")\n"}},ColorStyleSubject.parseColor=function(t){var e,i="#";if(e=ColorStyleSubject.parseColor.rgbRe.exec(t)){for(var r,o=1;3>=o;o++)r=Math.max(0,Math.min(255,parseInt(e[o]))),i+=ColorStyleSubject.toColorPart(r);return i}if(e=ColorStyleSubject.parseColor.hexRe.exec(t)){if(3==e[1].length){for(var o=0;3>o;o++)i+=e[1].charAt(o)+e[1].charAt(o);return i}return"#"+e[1]}return!1},ColorStyleSubject.toColorPart=function(t){t>255&&(t=255);var e=t.toString(16);return 16>t?"0"+e:e},ColorStyleSubject.parseColor.rgbRe=/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i,ColorStyleSubject.parseColor.hexRe=/^\#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/,DiscreteStyleSubject.prototype={setState:function(t){for(var e=0;e<this.els.length;e++)this.els[e].style[this.property]=t<=this.threshold?this.from:this.to},inspect:function(){return"	"+this.property+"("+this.from+" to "+this.to+" @ "+this.threshold+")\n"}},CSSStyleSubject.prototype={parseStyle:function(t,e){var i={};if(-1!=t.indexOf(":"))for(var r=t.split(";"),o=0;o<r.length;o++){var s=CSSStyleSubject.ruleRe.exec(r[o]);s&&(i[s[1]]=s[2])}else{var n,a,l;l=e.className,e.className=t;for(var o=0;o<CSSStyleSubject.cssProperties.length;o++)n=CSSStyleSubject.cssProperties[o],a=CSSStyleSubject.getStyle(e,n),null!=a&&(i[n]=a);e.className=l}return i},setState:function(t){for(var e=0;e<this.subjects.length;e++)this.subjects[e].setState(t)},inspect:function(){for(var t="",e=0;e<this.subjects.length;e++)t+=this.subjects[e].inspect();return t}},CSSStyleSubject.getStyle=function(t,e){var i;return document.defaultView&&document.defaultView.getComputedStyle&&(i=document.defaultView.getComputedStyle(t,"").getPropertyValue(e))?i:(e=Animator.camelize(e),t.currentStyle&&(i=t.currentStyle[e]),i||t.style[e])},CSSStyleSubject.ruleRe=/^\s*([a-zA-Z\-]+)\s*:\s*(\S(.+\S)?)\s*$/,CSSStyleSubject.numericalRe=/^-?\d+(?:\.\d+)?(%|[a-zA-Z]{2})?$/,CSSStyleSubject.discreteRe=/^\w+$/,CSSStyleSubject.cssProperties=["azimuth","background","background-attachment","background-color","background-image","background-position","background-repeat","border-collapse","border-color","border-spacing","border-style","border-top","border-top-color","border-right-color","border-bottom-color","border-left-color","border-top-style","border-right-style","border-bottom-style","border-left-style","border-top-width","border-right-width","border-bottom-width","border-left-width","border-width","bottom","clear","clip","color","content","cursor","direction","display","elevation","empty-cells","css-float","font","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","height","left","letter-spacing","line-height","list-style","list-style-image","list-style-position","list-style-type","margin","margin-top","margin-right","margin-bottom","margin-left","max-height","max-width","min-height","min-width","orphans","outline","outline-color","outline-style","outline-width","overflow","padding","padding-top","padding-right","padding-bottom","padding-left","pause","position","right","size","table-layout","text-align","text-decoration","text-indent","text-shadow","text-transform","top","vertical-align","visibility","white-space","width","word-spacing","z-index","opacity","outline-offset","overflow-x","overflow-y"],AnimatorChain.prototype={setOptions:function(t){this.options=Animator.applyDefaults({resetOnPlay:!0},t)},play:function(){if(this.forwards=!0,this.current=-1,this.options.resetOnPlay)for(var t=0;t<this.animators.length;t++)this.animators[t].jumpTo(0);this.advance()},reverse:function(){if(this.forwards=!1,this.current=this.animators.length,this.options.resetOnPlay)for(var t=0;t<this.animators.length;t++)this.animators[t].jumpTo(1);this.advance()},toggle:function(){this.seekTo(this.forwards?0:1)},listenTo:function(t){var e=t.options.onComplete,i=this;t.options.onComplete=function(){e&&e.call(t),i.advance()}},advance:function(){if(this.forwards){if(null==this.animators[this.current+1])return;this.current++,this.animators[this.current].play()}else{if(null==this.animators[this.current-1])return;this.current--,this.animators[this.current].reverse()}},seekTo:function(t){0>=t?(this.forwards=!1,this.animators[this.current].seekTo(0)):(this.forwards=!0,this.animators[this.current].seekTo(1))}},Accordion.prototype={setOptions:function(t){this.options=Object.extend({sections:null,getActivator:function(t){return document.getElementById(t.getAttribute("activator"))},shift:0,initialSection:0,rememberance:!0,animatorOptions:{}},t||{})},show:function(t){for(var e=0;e<this.ans.length;e++)this.ans[e].seekTo(e>t?1:0);this.options.rememberance&&(document.location.hash=this.rememberanceTexts[t])}};;
define("Soundmanager.360.events",["jquery","underscore","IGA.events"],function(a,b,c){"use strict";function d(){return"undefined"!=typeof ga}function e(b,c){var e=a(c._360data.oLink),f=e.closest(".field-collection-item-field-tracks"),g=f.find(".field--name-asf-discography-song-title"),h=g.attr("data-song-nid"),i=g.attr("data-song-title");d()&&ga("send","event","Discography",b,i+" ("+h+")")}return"undefined"==typeof threeSixtyPlayer?c:(b.each(threeSixtyPlayer.events,function(a,d){threeSixtyPlayer.events[d]=b.wrap(threeSixtyPlayer.events[d],function(a){c.trigger("Soundmanager.360."+d,[this]),a.apply(this)})}),require(["Soundmanager.360.events"],function(a){a.on("Soundmanager.360.play",b.partial(e,"play")),a.on("Soundmanager.360.pause",b.partial(e,"pause")),a.on("Soundmanager.360.finish",b.partial(e,"finish"))}),c)});
//# sourceMappingURL=/sites/all/modules/custom/asf_discography/js/asf_discography.min.js.map
;
/**
 * @file Twitter, Facebook, and Google+ social scripts and GA Event tracking
 */

(function(){
	"use strict";
	// # Social Scripts

	// ## Google Analytics Event Tracking
	var __icsaStart = Date.now(),
		ga = (typeof window.ga === "undefined") ? function(){} : window.ga;
	var attachGAEvents =
	IGA.social = {
		attach: {
			facebook: function(FB){
				if(IGA.social.fbAttached){ return; }else{ IGA.social.fbAttached = true; }
				FB.Event.subscribe('edge.create',
					function(href, widget) {
						//when a user has liked a url.
						ga("send", "event", "Social", "facebook.like", href );
					}
				);
				FB.Event.subscribe('edge.remove',
					function(href, widget) {
						//when a user has unliked a url.
						ga("send","event", "Social", "facebook.unlike", href );
					}
				);
				FB.Event.subscribe('message.send',
					function(href) {
						//when a user has used the send button.
						ga("send", "event", "Social", "facebook.message.send", href );
					}
				);
				ga('send', 'timing', 'Facebook', 'fbAsyncInit', Date.now() - __icsaStart);
			},
			googleplus: function(){
				if(IGA.social.gpAttached){ return; }else{ IGA.social.gpAttached = true; }
				IGA.onYtEvent = function(payload){
					if (payload.eventType === 'subscribe') {
						ga("send", "event", "Social", "youtube.subscribe", payload.channelExternalId );
					} else if (payload.eventType === 'unsubscribe') {
						ga("send","event", "Social", "youtube.unsubscribe", payload.channelExternalId );
					}
				};

				window.googleplusone_callback = function (data){//{"href": target URL, "state": "on"|"off" }
					ga("send", "event", "Social", "googleplus.plusone"+((data.state === "off")?".off":""), data.href );
				};
				ga('send', 'timing', 'Googleplus', 'gplusLoad', Date.now() - __icsaStart);
			},
			twitter: function(twttr){
				if(IGA.social.twAttached){ return; }else{ IGA.social.twAttached = true; }
				var event_names = {
					"click" :   "" ,// Track first interaction click
					"tweet" :  "",
					"retweet" : "source_tweet_id",
					"follow" : "screen_name",
					"favorite" : "tweet_id"
				};
				function trackIntent(intent_event){
					if(intent_event){
						var label = intent_event.type==="click" ? intent_event.region : (intent_event.data) ? intent_event.data[event_names[intent_event.type]] : "";
						ga("send", "event", "Social", "twitter." + intent_event.type, label);
					}
				}
				for(var event_name in event_names){
					if(event_names.hasOwnProperty(event_name)){
						twttr.events.bind(event_name, trackIntent);
					}
				}
				ga('send', 'timing', 'Twitter', 'twttr.ready', Date.now() - __icsaStart);
			}
		}
	};
})();;
/**
 *
 */
//# Main Carousel Banner Analytics Tracking
define("bolero.slickAnalytics", ["jquery", "underscore", "IGA.events", "bolero.analytics", "googleanalytics", "jquery/plugins/jquery.viewport.min"],
	function($, _, events, boleroAnalytics){
	"use strict";
	function SlickAnalytics(el){
		this.$el = $(el);
		this.$slides = [];
		this.noDupes = {};
		var $el = this.$el, name = "NONE", eventId = "slick";
		if($el.is(".l-banner .l-region--banner")){
			name = "Banner";
			eventId = "banner";
		}else if($el.is(".view")){
			name = $el.attr("data-view-name");
			eventId = "view-"+$el.attr("data-view-id")+"--"+$el.attr("data-view-display-id");
		}
		this.name = name;
		this.eventId = eventId;
		this.initialized = false;
		this.viewed = [];
	}

	SlickAnalytics.prototype.init = function(slider){
		var self = this;
		this.slider = slider;
		this.$slides = slider.$slides;
		this.trackClicks();
		var _trackViews = _.bind(this.trackViews, this);
		IGA.events.on("bolero."+this.eventId+".beforechange", function(){ self.noDupes = {}; });//clear out duplicate detection buffer
		IGA.events.on("bolero."+this.eventId+".afterchange", _trackViews);
		if(!this.initialized){
			_.defer(_trackViews);
		}
		$(window).on("scroll", _.debounce(_trackViews, 250));
		if(this.$slides){
			this.$slides.not(".slick-cloned, .bolero-sa-initialized").addClass("bolero-sa-initialized");
		}
		this.initialized = true;
	};

	 function _findOriginalSlide($clone, $slides){
		var classes = $clone[0].className.replace("slick-cloned", "").trim(),
			slideSelector = "."+classes.split(/\s+/).join("."), //let's get all the classes into a selector
			$originalSlide = $slides.filter(slideSelector).first();
		//here it is, use this slide index instead.
		return $originalSlide;
	}

	SlickAnalytics.prototype.trackViews = function(){
		var self = this,
			_slideZTop = 0;
		if(!this.$slides){ return; }
		_.each(this.$slides, function(el){
			var _z = parseInt(el.style["z-index"]);
			if(_z > _slideZTop){ _slideZTop = _z; }
		});

		this.$slides.siblings().each(function(i){//.not(".slick-cloned")
			var $this = $(this),
				$slide = $this,
				$node = $slide.children(".node"),
				z_index = parseInt(this.style["z-index"] || 0),
				offset = $this.offset(),
				$container = $this.parent().parent(),
				container_offset = $container.offset(),
				container_width = $container.width();
			//## Track which slides have been seen
			if( z_index >= _slideZTop && $this.is(":visible") && //not faded out or display:none
				$.inviewport($this, { threshold: -100 }) && !$.leftofscreen($this, {threshold: 100}) && //on the screen
				offset.left - container_offset.left >= 0 && offset.left - container_offset.left < container_width && //in the container
				!self.noDupes[i])
			{
				//To count slides must be on the top of the z-index, visible, within the viewport, and within the container.
				if($this.is(".slick-cloned")){
					//... but what is the actual, not-cloned slide?
					$slide = _findOriginalSlide($this, self.$slides);
				}
				var slide_num = _.indexOf(self.$slides, $slide[0]) + 1,
					ga_label = boleroAnalytics.label($node) || "slide-"+slide_num,
					timing = Date.now() - boleroAnalytics.start;// track when the node was viewed
				self.noDupes[i] = true;
				//Track that the banner at this index has been seen.
				if(!self.viewed[slide_num]){ ga("send", "event", "Carousel : " + self.name, "impression", ga_label, timing, {nonInteraction: 1}); }
				self.viewed[slide_num] = true;
				//TODO add nodeID tracking when using DS.
			}
		});
	};

	SlickAnalytics.prototype.trackClicks = function(){
		//## Track clicks on slides
		var self = this;
		if(!this.$slides){ return; }
		this.$slides.siblings().not(".bolero-sa-initialized").each(function(i){
			// that haven't already been initialized
			$(this).one("click", function(){
				var $this = $(this),
					$slide = $this,
					$node = $slide.children(".node");
				if($this.is(".slick-cloned")){
					//... but what is the actual, not-cloned slide?
					$slide = _findOriginalSlide($this, self.$slides);
				}
				var slide_num = _.indexOf(self.$slides, $slide[0]) + 1,
					ga_label = boleroAnalytics.label($node)|| "slide-"+slide_num;
				ga("send", "event", "Carousel : " + self.name, "click", ga_label, 1);
			});
		});
	};

	return SlickAnalytics;
});;
/*globals require, requirejs, define, jQuery, Drupal, IGA */
define("bolero.form", ["jquery", "underscore", "Drupal.ajax"], function ($, _) {
	"use strict";
	function BoleroForm($container, form_id, data, settings) {
		//TODO change settings.useAjax -> settings.ajaxLoad
		this.data = data || {};
		this.settings = settings || {};
		//TODO if $container.is("form") wrap it.
		if($container.is("form")){
			if(!$container.parent().is(".bolero-ajax-form-wrapper")){
				$container.parent().addClass("bolero-ajax-form-wrapper");
			}
			$container = $container.parent();
		}else if(!$container.is(".bolero-ajax-form-wrapper")){
			$container.addClass("bolero-ajax-form-wrapper");
		}
		//Check the registry for existing forms
		this.$container = $container;
		if(!form_id){
			form_id = $container.attr("data-bolero-form-id");
		}
		this.$form = $container.children("form");

		if(this.$form.length > 0){
			if(!form_id){
				form_id = this.$form.find("input[name=form_id]").val();
			}
			this.setupForm();
		}
		if(BoleroForm.registry[form_id]){
			var bf = BoleroForm.registry[form_id];
			if(data){ bf.data = data; }
			_.extend(bf.settings, settings);
			return bf;
		}
		this.form_id = form_id;
		this.endpoint = "/api/bolero/form/"+form_id;
		this.ajax = new Drupal.ajax(null, $container, { url: this.endpoint });
		this.initSettings();
		//TODO use form_build_id ?

		BoleroForm.registry[form_id] = this;
		return this;
	}

	BoleroForm.registry = [];

	BoleroForm.prototype.delete = function(){
		delete BoleroForm.registry[this.form_id];
		this.$container.remove();
	};

	BoleroForm.prototype.load = function(reload){
		if(reload === true){
			this.$form.remove();
		}
		if(this.$form.length === 0){
			return this.get();
		}else{
			var deferred = $.Deferred();
			deferred.resolve(false);
			//return a jQuery promise to mimic $.ajax().done()
			return deferred.promise();
		}
	};

	BoleroForm.prototype.request = function(endpoint){
		endpoint = this.endpoint + (endpoint || "");
		if(this.inProgress){ return $.Deferred().promise(); }
		var self = this,
			postData = this.$form.serializeArray() || [];
		//add ajax_page_state to allow drupal_add_js/css ajax to work.
		_.each(["css", "js"], function(type){
			if(Drupal.settings.ajaxPageState){
				for(var key in Drupal.settings.ajaxPageState[type]) {
					postData.push({name:"ajax_page_state["+type+"]["+key+"]", value: 1});
				}
			}
		});
		//Drupal forms use non-unique ids with an id--# suffix so we must pass all of the existing elements
		//@see misc/ajax.js : Drupal.ajax.prototype.beforeSerialize
		var html_ids = _.reduce($('[id]'), function(ids, el){
			ids.push(el.id);
			return ids;
		}, []);
		postData.push({name:"ajax_html_ids[]", value: html_ids});
		//TODO
		//options.data['ajax_page_state[theme]'] = Drupal.settings.ajaxPageState.theme;
		//options.data['ajax_page_state[theme_token]'] = Drupal.settings.ajaxPageState.theme_token;

		for(var key in this.data) {
			postData.push({name:key, value: this.data[key]});
		}

		var has_triggering_element = false;
		for(var data in postData){
			if(data.name === '_triggering_element_name'){
				has_triggering_element = true;
			}
		}
		if(!has_triggering_element && self.settings[this.formSubmitId] && self.settings[this.formSubmitId].submit){
			var tEN = self.settings[this.formSubmitId].submit._triggering_element_name;
			if(tEN){
				postData.push({ name:"_triggering_element_name", value: tEN });
			}
		}

		this.inProgress = true;
		return $.ajax({
			type: 'POST',
			url: endpoint,
			data: postData
		}).always(function(){ self.inProgress = false; });
	};

	BoleroForm.prototype.get = function(endpoint){
		return this.request(endpoint).done(_.bind(this.insert, this));
	};

	BoleroForm.prototype.rebuild = function(){
		return this.get("/rebuild");
	};

	BoleroForm.prototype.validate = function(){
		this.submitText();
		return this.get("/validate");
	};

	BoleroForm.prototype.submit = function(){
		var self = this;
		this.submitText();
		if(this.settings.useAjax === false){
			var form = this.$form[0];
			form.action = location.pathname;
			form.submit();
		}else if(this.settings.ajax && this.settings.ajaxSubmit){
			//if there are ajax settings for this form then submit it
			this.$form.ajaxSubmit({
				success: function(response, status){
					self.insert(response, status);
					self.$form.removeClass("state--submitting");
				}
			});
		}else{
			//otherwise, use the bolero ajax form submit
			return this.get("/submit").done(function(){
				self.$form.removeClass("state--submitting");
			});
		}
	};

	BoleroForm.prototype.submitText = function(){
		var self = this;
		this.$form.addClass("state--submitting");
		if(this.$formSubmit){
			if(!this._submitAttached){
				var defaultText = this.$formSubmit.val();
				this.$form.on("submitted validated error", function(){
					self.$form.removeClass("state--submitting");
					self.$formSubmit.val(defaultText);
				});
				this._submitAttached = true;
			}
			this.$formSubmit.val(this.settings.submitText || "Submitting...");
		}

	};

	BoleroForm.prototype.insert = function(response, status){
		var data, settings;
		for(var i = 0; i< response.length; i++){
			data = response[i];
			if(data.command === "settings"){ settings = data.settings; }
			if(data.settings && data.settings.bolero_form === true ){
				data.selector = this.$container;
				//merge in the settings b/c they aren't available until the end of ajax_render
				data.settings = $.extend(data.settings, settings);
				//insert and Drupal.attachBehaviors
				this.ajax.commands.insert(this.ajax, data, status);
				this.$form = this.$container.children("form");
				this.setupForm(settings);
			}else if(data){
				data.selector = data.selector || this.$form;
				if(typeof this.ajax.commands[data.command] === "function"){
					if(data.command === "invoke" && data.method === "trigger"){
						// Wait for the form done callback before triggering events.
						_.defer(function(data, ajax){
							ajax.commands[data.command](ajax, data, status);
						}, data, this.ajax);
					}else{
						this.ajax.commands[data.command](this.ajax, data, status);
					}
				}
			}
		}
		this.initSettings(settings);
	};

	//## When we have a form
	BoleroForm.prototype.setupForm = function(){
		var self = this;
		this.$formSubmit = this.$form.find(".form-submit");
		this.formSubmitId = (this.$formSubmit.length) ? this.$formSubmit[0].id : null;
		//override Drupal ajaxSubmit
		this.$formSubmit.each(function(){
			var $formSubmit = $(this),
				ajax = Drupal.ajax[this.id];
			$formSubmit.once("bolero-form", function(){
				$formSubmit.on("click", function(e){
					//If there are events bound to the form submit
					var events = $._data(self.$form[0], "events");
					if(events && events.submit){
						// trigger them
						var fe = $.Event("submit");
						self.$form.trigger(fe);// submit.bolero.formSubmit
						if(!fe.isPropagationStopped() && ajax){
							// and continue or allow submit event handlers to prevent ajaxSubmit
							ajax.eventResponse(this, e);
						}
					}else{
						if(!self.settings.ajaxSubmit){
							self.submit();
						}else if(ajax){
							ajax.eventResponse(this, e);
						}
					}
				}).addClass("ajax-processed");
				if(Drupal.ajax[this.id]){
					$formSubmit.off("mousedown");
					//delete Drupal.ajax[this.id];
				}
			});
		});
	};

	BoleroForm.prototype.initSettings = function(){
		var self = this;
		this.settings = this.settings || {};
		if(this.$form.length > 0){
			this.$formSubmit.each(function(){
				var submit_id = this.id;
				self.settings.ajax = false;
				self.settings.ajaxSubmit = false;
				if(Drupal.settings.ajax && Drupal.settings.ajax[submit_id]){
					self.settings[submit_id] = Drupal.settings.ajax[submit_id];
					self.settings.ajax = true;
					//by default use the Bolero form submit instead b/c it has better error handling w/ events.
					self.settings.ajaxSubmit = self.settings.ajaxSubmit || false;
				}
			});
		}
		return this.settings;
	};

	return BoleroForm;
});
;
/**
 * @file bolero.user_login.js
 */
/*globals require, requirejs, define, jQuery, Drupal, IGA, aeJS */
//# Bolero User Login
define("bolero.user_login", ["jquery", "underscore", "IGA.events", "IGA.user", "googleanalytics"], function($, _, events, iga_user){
    "use strict";
	// module scope static vars
	var $forms = $("#block-bolero-user-login-user-login-modal"),
		$ae_reg_forms = $('form#user-login, form#user-register-form, form#ae-required-fields'),
		dbae = Drupal.behaviors.ae_social_login,
		dsae = Drupal.settings.ae_social_login,
		dsbul = Drupal.settings.bolero_user_login || {},
		ae_form_field_mapping = Drupal.settings.ae_social_login ? Drupal.settings.ae_social_login.form_field_mapping : null,
		ae_forms = Drupal.settings.ae_social_login ? Drupal.settings.ae_social_login.forms || [] : [];
	dsbul.isMobile = dsae && dsae.settings ? !dsae.settings.auth_window : false;

    var bul = {
	    flow: "login",
	    $forms: $forms,
	    isBlock: $forms.length > 0,
	    isModal: $forms.is("[data-reveal]"),
	    isMobile: dsbul.isMobile,
	    opened: false, // TODO isOpened, isInitialized
	    initialized: false,
	    data: {},
	    //## Initialize Bolero Modal
	    init: function(){
		    if(!bul.initialized){
			    $forms.form = $forms.find(".user-login-forms .login form");
			    // ### Attach login / register form handler
			    if($ae_reg_forms.length > 0){
				    $forms = $ae_reg_forms;
			        bul.isModal = false;
				    bul.isBlock = false;
				    this.attach();
				    $ae_reg_forms.each(bul.handlers.ae_register_form);
		        }else if(bul.isBlock){
				    //### Update the Drupal login to show the modal
				    IGA.drupal.login = function(){
					    //Override to use Foundation reveal modal login block if present.
					    bul.open();
				    };
				    this.attach();
				    if($forms.attr("data-default-form") === "register"){
					    bul.handlers.register();
				    }else{
					    bul.handlers.login();
				    }
			    }

			    //### Attach social handler
			    if($forms.social){
				    $forms.social.on("click", bul.actions.social);
			    }

			    //### Listen for AE Connect social login
			    events.on("ae_ready", bul.attachAE).replay("ae_ready", bul.attachAE);

			    this.initialized = true;
			    //### Basic ui events
			    $forms.on("close.fndtn.reveal", function(){
				    bul.opened = false;
			    });
				if(iga_user.ae_user){
					// Add connected service classes
					var $html = $("html"),
						ae_user = iga_user.ae_user;
					for(var s in ae_user.services){
						$html.addClass("ae-connected--"+ ae_user.services[s].Service);
					}
				}
		    }
		    return this;
	    },
	    open: function(reset){
		    //TODO update bul.opened once onLogin provides sso flag
		    if(reset !== false){ bul.data = {}; }
		    this.updateSocials();
		    if(!bul.isModal){
			    if(bul.isBlock){
				    // inline block, treat the same but no need for reveal.
				    bul.$forms.removeClass("hidden").show();
				    // scroll to $forms
				    $("html,body").animate({
					    scrollTop: bul.$forms.offset().top
				    }, 800);
			    }else{
				    //window.location = "/user/" + bul.flow; return;
			    }
		    }else{
			    require(["foundation.reveal"], function(){
				    events.trigger("bolero.user_login.open");
				    $forms.foundation('reveal', 'open');
			    });
		    }
		    var has_been_opened = bul.opened;
		    bul.opened = true;
		    bul.actions.set_display();
		    if(!has_been_opened){
			    ga("send", "event", "Bolero Login", "opened", bul.flow, null, {
				    dimension4: bul.data.display
			    });
		    }
	    },
	    updateSocials: function(){
		    var $socialsContainer = $forms.social.first().parent(), services = [];
		    if(typeof aeJS === "object" && aeJS.user.services){
			    $forms.social.each(function(){
				    var $social = $(this);
				    services.push($social.attr("data-ae-register-form-link"));
			    });

			    _.each(aeJS.user.services.reverse(), function(s){
				    var service = s.Service, $service;
				    if(service === "email"){ return; }
				    if(service === "youtube" && services.indexOf("google") >= 0){
					    $service = $forms.social.filter("."+service);
					    $service.detach();
					    return;
				    }
				    if(services.indexOf(service) === -1){
					    $service = $(bul.ae_login_link(service));
					    $service.on("click", bul.actions.social);
					    $socialsContainer.prepend($service);
				    }else{
					    $service = $forms.social.filter("."+service);
					    $service.detach();
					    $socialsContainer.prepend($service);
				    }
			    });
		    }

		    $forms.social = $socialsContainer.children();
		    if($socialsContainer.length > 0){
			    var socialsCount = $forms.social.length,
				    classes = $socialsContainer[0].className.split(/\s+/);
			    _.each(classes, function(className){
				    if(className.indexOf("social-link-count--") === 0){
					    $socialsContainer.removeClass(className);
				    }
			    });
			    $socialsContainer.addClass("social-link-count--"+socialsCount);
		    }
	    },
	    close: function(){
		    events.trigger("bolero.user_login.close");
		    $forms.foundation('reveal', 'close');
	    },
	    //## (re)Attach DOM Elements
	    attach: function(){
		    var self = this;
		    $.extend(true, $forms, {
			    state: "state--login state--register state--password state--required-fields",
			    header: {
					login: $forms.find("header .login"),
					register: $forms.find("header .register")
			    },
			    forms: $forms.find(".user-login-forms"),
			    login: $forms.find(".user-login-forms .login, header"),
			    register: $forms.find(".user-login-forms .register, header"),
			    password: $forms.find(".user-login-forms .password"),
			    messages: $forms.find(".messages"),
			    social: $forms.find(".ae-social-login-links a")
			});

		    if(!bul.isModal){
			    // use page messages
			    $forms.messages = $(".messages");
		    }

		    //### Show user_register form
		    $forms.find("header .register").once("bolero-emcee-login", function(){
			   $(this).on("click", _.bind(bul.handlers.register, self));
		    });

		    //### Show user_login form
		    $forms.find("header .login, .user-login-forms .password .user-login-link").once("bolero-emcee-login", function(){
			   $(this).on("click", _.bind(bul.handlers.login, self));
		    });

		    if(iga_user.uid){
			    // In the authenticated state update to "connect"
			    $forms.header.login.find("h2").text("Connect");
			    $forms.header.login.find("h2 + span").text(" an additional account");
			    $forms.find("#bolero-user-login-submit").val("Connect");
			    $forms.login.removeAttr("data-ae-type");
			    $forms.addClass("state--connect");
		    }

		    //### Show user_password form
		    $forms.find(".password-reset-link a").once("bolero-emcee-login", function(){
			  $(this).on("click", _.bind(bul.handlers.password, self));
		    });

			bul.attachRegister();
			return this;
	    },
	    //### Update Registration Form UI
	    attachRegister: function(){
		    $("form#bolero-user-register, form#user-register-form").once(function(){
			    var $register = $(this),
				    $email = $register.find("#edit-mail"),
				    $username = $email.parent().siblings(".form-item").find(".username").first(),
				    $password = $register.find(".form-item-pass-pass1"),
				    $password_confirm = $register.find(".form-item-pass-pass2"),
				    $password_strength = $password.find(".password-strength"),
				    $password_confirm_msg = $password_confirm.find("div.password-confirm");
			    //Autocomplete username based off of the email
			    var updateUsername = _.debounce(function(){
				    var username = $email.val().split("@")[0];
				    $username.val(username);
			    }, 200);
			    $email.on("input", updateUsername);
			    // but remove the autocomplete if the user updates their username
			    $username.on("focus", function(){ $email.off("input", updateUsername); });

			    //move the password strength & confirm check
			    $password_strength.detach().appendTo($password);
			    $password_confirm_msg.detach().appendTo($password_confirm);

		    });
		    return this;
	    },
	    //## Once AE is ready
	    attachAE: function(aeJS){
		    // Listen for AE user events;
		    if(bul.isBlock){
				aeJS.events.onLogin.addHandler(bul.handlers.required_fields);
		        aeJS.events.onUser.addHandler(bul.handlers.required_fields);
		    }

		    function onFlow(e){
			    if(e.step === "error"){
				    bul.handlers.error(null, {
					    type: "AE Connect : " + bul.flow,
					    message: e.error,
					    errors : { ae_user: true }
				    }, true);
			    }else if(e.step === "remove"){
				    bul.flow = "login";
				    bul.actions.login(aeJS.user, e.step);
			    }
		    }

		    events.on("ae_flow", onFlow).replay("ae_flow", onFlow);
		    //TODO tracktiming b/w social open & onUser / onLogin
		},
	    //## Attach Forms
	    attachForm: function(bolero_form){
		    var $form = bolero_form.$form,
			    form_id = bolero_form.$form.attr('id');// element Id
		    if(!$forms.form){ $forms.form = $form; }
		    function ae_attach(aeJS){
			    // If AE is available, submit w/ AE.
			    if(!$form.is("[data-ae-register-form]") && ae_forms.indexOf(form_id) >= 0 || bolero_form.settings.ae_attached === false ){
				    $form.attr("data-ae-register-form", "email");
				    aeJS.trigger.attach($form[0]);
				    bolero_form.settings.ae_attached = true;
			    }
			    if($form.is("form[data-ae-type=login]")){
				    $form.one("user", function(){
					    $form.removeAttr("data-ae-type");
				    });
			    }
		    }

		    // Attach custom submit + validate handler
		    bolero_form.onSubmit = _.partial(bul.actions.submit, bolero_form);
		    $form.on("submit", bolero_form.onSubmit);

		    events.on("ae_ready", ae_attach).replay("ae_ready", ae_attach);
		    if(!bolero_form.settings.attached){
			    // One-time form initialization
			    bolero_form.$form.on("login", bul.events.login).on("register", bul.events.register);
			    bul.setOptout(bolero_form);
			    bolero_form.settings.attached = true;
		    }
	    },
	    detachForm: function(bolero_form){
		    bolero_form.$form.find("input[name=ae_user]").empty();
		    // Remove the AE form submit and error handler
		    bolero_form.$form.off("submit error");
		    bolero_form.settings.ae_attached = false;
	    },
	    setOptout:function(bolero_form){
		    var $inline_et_lists = $(".bolero-login-buttons--et-lists input"),
		        $et_lists = bolero_form.$form.find(".et-lists input").add($inline_et_lists),
			    subscribedCount = 0;
		    if(!require.specified("ExactTarget")){ return; }
		    if($inline_et_lists.length > 0){
			    bul.inline_optins = true;
			    ga("set", { "dimension4": "inline" });
		    }

			require(["ExactTarget", "IGA.webshim.storage"], function(ET){
				var optins = bul.actions.clear_optins();
				$et_lists.once("bul", function(){
					var $et_list = $(this), self = this,
						listId = $et_list.val(),
				        isOptedOut = ET.isOptedOut(listId),
					    isSubscribed = ET.isSubscribed(listId);
				    if(isOptedOut || isSubscribed || dsbul.optout_default){
					    // If the user has opted out of the list, respect opt-out;
					    // also uncheck if the user is already subscribed so ET doesn't attempt to re-subscribe (b/c expensive).
					    $et_list.prop( "checked", false );
					    $.cookie("et_subscribe_default_"+listId, 0, { expires: -1, path: '/' });
				    }else{
					    // otherwise, pre-check the checkbox
					    $et_list.prop( "checked", true );
					    $.cookie("et_subscribe_default_"+listId, '1', { path: '/' }); // cookie used for redirect
					    optins[listId] = 1;
				    }
				    if(isSubscribed){
					    $et_list.closest(".form-item").hide();
					    subscribedCount++;
				    }

					events.on("user.clear", function(){
						// There's a new user, remove past subscription.
						localStorage.removeItem("et_list_subscribed_"+listId);
					});

				    // and listen for any future opt-out / opt-in.
				    $et_list.on("click", function(){
					    bul.et_optout = true;
					    // After the user has checked an ET optin
					    var checked = $et_list.prop("checked");
					    // update their opt-out status.
					    if(checked === false){
						    ET.setOptOut(listId, true);
					    }else if(checked === true){
						    ET.setOptOut(listId, false);
					    }
					    events.trigger("optin."+listId,[checked, this]);
				    });
					events.on("optin."+listId, function(checked, target){
						if(target !== self){
							$et_list.prop("checked", checked);
						}
					});
				    ET.addList($et_list, "bolero_user_login", bolero_form.$form);
			    });
			    if(subscribedCount === $et_lists.length){
				    $forms.form.find(".et-lists.form-checkboxes").closest(".form-item-lists").hide();
				    $forms.form.find(".et-disclaimer").hide();
				    $(".bolero-login-buttons--et-lists").hide();
			    }
				localStorage.setItem("et_list_optins", JSON.stringify(optins));
				events.trigger("bolero.exacttarget.ready");
		    });
	    },
	    ae_login_link_template: _.template('<a href="#" data-ae-register-form-link="{{service}}" class="ae-link login {{service}}" ><i class="icon icon-{{service}}"></i><span class="label"><span class="auth-action">Login</span><span class="with"> with </span><span class="social">{{Service}}</span></span></a>'),
	    ae_login_link: function(service){
		    return bul.ae_login_link_template({ service: service, Service: service.charAt(0).toUpperCase() + service.slice(1) });
	    },
	    actions: {
		    //### Social Login / Registration
		    social: function(e){
			    var $social = $(this),
				    network = $social.attr("data-ae-register-form-link");
			    e.preventDefault();
			    $forms.form.attr("data-ae-register-form", network);
			    function submit(){
				    if(bul.isMobile){
					    ga("send", "event", "AE Connect", "opened", network, null);
					    IGA.setConversion(IGA.conversionPt, true);
				    }
				    aeJS.trigger.authenticate(network, dbae.auth);
				    bul.data.provider = network;
			    }
			    events.on("ae_ready", submit).replay("ae_ready", submit);
		    },
		    //### Email Login / Registration
		    submit: function(bolero_form, e){
			    e.preventDefault();
			    e.stopImmediatePropagation();
			    var $form = bolero_form.$form, form = $form[0];
			    bul.data.provider = "email";
			    function removeSubmit(){
				    // If no errors submitting to AE remove AE submit
				    bolero_form.$form.off("submit", bolero_form.onSubmit);
				    // defer removing this listener otherwise it breaks loop
				    _.defer(function(){ aeJS.events.onUser.removeHandler(removeSubmit); });
			    }
			    if($form.is("form[data-ae-register-form]")){
				    aeJS.events.onUser.addHandler(removeSubmit);
				    $form.once("bul-form-submit", function(){
					    bolero_form.$form.on("validated", function(){
						    //#### Once Validated
						    removeSubmit();
						    if(bul.flow === "login"){
							    // Map user login name / email field to username / email
							    var $name = $form.find('input[name="name"]'),
								    name = $name.val();
							    if(name.indexOf("@") > 0){
								    // name is an email
								    var username = name.split('@')[0];
								    ae_form_field_mapping[bolero_form.form_id + ".name"] = "email";
								    // set a default username
							    }else{
								    //form name is an username
								    ae_form_field_mapping[bolero_form.form_id + ".name"] = "username";
							    }
						    }
						    dbae.map_ae_fields($form);
						    // submit the form to AE login / register.
						    aeJS.trigger.submit(form);
						    bul.ae_login_start = Date.now();
					    });
				    });
				    bolero_form.validate();
			    }else{
				    // Otherwise, just submit.
				    bolero_form.submit();
			    }
		    },
		    //## AE Login / Register Form Submit
		    login: function(ae_user, type, options){
			    options = options || {};
			    if(options.remoteOnly){
				    events.trigger("bolero.remote_login", [ae_user, type, options]);
				    if(bul.opened){ bul.close(); }
				    return;
			    }
			    //This should be the local flow rather than if this is a login / register in ae
			    bul.handlers[bul.flow](null, false);
			    // add the ae_user data to the form hidden input
			    var $ae_user = $forms.form.find("input[name=ae_user]");
			    $ae_user.val(JSON.stringify(ae_user));
			    dbae.remove_ae_field_mappings($forms.form);
			    // and submit via AJAX.
			    require(["bolero.form"], function(BoleroForm){
				    var bolero_form = new BoleroForm($forms.form);
				    $forms.form[0].action = (bolero_form.formSubmitId) ? Drupal.settings.ajax[bolero_form.formSubmitId].url  : "/system/ajax";
				    bolero_form.data.campaign = IGA.conversionPt;
				    bul.actions.set_display();
				    bolero_form.data.display = bul.data.display;
				    bolero_form.data.nid = bul.data.nid;
				    bolero_form.submit();
			    });

			    bul.handlers.prevent = false;
		    },
		    set_display: function(){
			    if(bul.opened){
				    if(bul.opened_required_fields){
					    bul.data.display = "modal required_fields";
				    }else if(bul.opened_et){
					    bul.data.display = "modal opt-in";
				    }else{
					    bul.data.display = "modal";
				    }
			    }else{
				    bul.data.display = "inline";
			    }
		    },
		    clear_optins: function(){
			    var optins = localStorage.getItem("et_list_optins");
			    optins = optins ? JSON.parse(optins) : {};
			    // Clear out old optins
			    _.each(optins, function(v, listId){
				    $.cookie("et_subscribe_default_"+listId, 0, { expires: -1, path: '/' });
				    delete optins[listId];
			    });
			    return optins;
		    },
		    clear_subscriptions: function(){
			    bul.actions.clear_optins();
			    $forms.find(".et-lists input").add(".bolero-login-buttons--et-lists input").each(function(){
				    $(this).prop( "checked", false );
			    });
		    },
		    casl: function(reason, broadcast){
			    //if(dsbul.optout_default){ return; }
			    dsbul.optout_default = true;
			    if(reason === "casl"){
				    dsbul.casl = true;
				    bul.$forms.find("div.et-disclaimer").add(".bolero-login-buttons--et-lists .et-disclaimer").append(bul.casl_message);
			    }
			    bul.actions.clear_subscriptions();
			    events.off("optout.default", bul.actions.optout_default);
			    if(reason && broadcast){ events.trigger("optout.default", [reason]); }
		    }
	    },
	    events: {
		    //## Login event callback
		    login: function(e, result){
			    var options = {},
				    user = result.user,
				    alreadyLoggedIn = iga_user.uid ? true : false;
			    if(typeof aeJS !== "undefined"){ options.ae_user = aeJS.user; }
			    if(alreadyLoggedIn){
				    bul.events.updated(user);
			    }
			    if(bul.data.nid){ options.nid = bul.data.nid; }
			    if(bul.data.title){ options.title = bul.data.title; }
			    if(bul.data.provider){ options.provider = bul.data.provider; }
			    if(bul.data.display){ options.display = bul.data.display; }
			    options.flow = bul.flow;
			    ga("send", "event", "Bolero Login", bul.flow, bul.data.provider, null);
			    events.trigger("login", [user, options]);
			    if(!alreadyLoggedIn){
				    $forms.form.addClass("state--loading");
				    var redirect_url = bul.data ? bul.data.redirect_url : null;
				    if(!redirect_url){
					    var url = IGA.utils.parseUrl(location.href);
					    if(url.params['?'].destination){
						   redirect_url = url.params['?'].destination;
						    if(redirect_url.charAt(0) !== "/"){ redirect_url = "/"+redirect_url; }
					    }
				    }
				    if(IGA.location.preventReload.reload === true){
					    bul.close();
					    $(document).trigger("messages");
				    }else{
					    IGA.location.reload(redirect_url);
				    }
				    bul.data = {};
			    }else{
				    bul.handlers.prevent = false;
				    bul.handlers.login();
			    }
		    },
		    updated: function(user){
			    bul.close();
			    var action = "connected", connected_service;
			    if(iga_user.ae_user && user.ae_user){
				    if(user.ae_user.services.length === iga_user.ae_user.services.length){
					    // No new services have been added.
					    action = "updated";
				    }else{
					    // Otherwise, find the new service.
					    var service, orig_service;
					    for(var s in user.ae_user.services){
						    service = user.ae_user.services[s];
						    connected_service = false;
						    for(var o in iga_user.ae_user.services){
							    if(service.ID === iga_user.ae_user.services[o].ID){
								    connected_service = true;
								    break;
							    }
						    }
						    if(connected_service === false){
							    connected_service = service;
						    }
					    }
				    }
			    }
			    if(typeof connected_service === "object"){
				    events.trigger(action, [connected_service.Service, connected_service, user]);
				    require(["bolero.snackbar"], function(Snackbar){
					    if(action === "connected"){
						    $("html").addClass("ae-connected--"+connected_service.Service);
						    Snackbar.add('<i class="icon icon-'+connected_service.Service+'"</i>Now connected as '+ connected_service.Username + '.', true, null, { type: "success"});
					    }else{
						    Snackbar.add("Success! Your account has been "+action+".", true, null, { type: "success"});
					    }
				    });
			    }
		    },
		    remote_login: function(user){
			    // TODO it'd be nice if we could figure out new vs. connected vs. already connected.
		    },
		    //## Register event callback
		    register: function(e, user){
			    var options = {};
			    if(typeof aeJS !== "undefined"){ options.ae_user = aeJS.user; }
			    events.trigger("register", [user, options]);
			    bul.events.login(e, user);
		    }
	    },
	    handlers: {
		    prevent: false,
		    login: function(e, attach, error){
			    if(bul.handlers.prevent){ return false; }
			    if(e){ e.preventDefault(); }
			    bul.flow = "login";
			    $forms.removeClass($forms.state).addClass("state--login");
			    $forms.header.login.addClass("active");
			    $forms.header.register.removeClass("active");
			    var formSelector = "form#bolero-user-login, form.bolero-user-login, form.user-login, form#user-login",
				    authAction = iga_user.uid ? "Connect" : "Login";
			    $forms.form = $forms.find(formSelector).andSelf().filter(formSelector);
			    $forms.social.find(".auth-action").text(authAction);
			    //On state change, hide the previous messages
			    if(!error){ $forms.messages.hide(); }
			    require(["bolero.form"], function(BoleroForm){
				    var submitText = (iga_user.uid) ? "Connecting..." : "Logging In...",
					    bolero_form = new BoleroForm($forms.form, null, null, { submitText: submitText });
				    attach = attach || !bolero_form.settings.attached;
				    if(attach !== false){
					    bul.handlers.form($forms.form);
					    // If using AE connect validate using bolero_form and submit to AE before submitting locally.
					    bul.attachForm(bolero_form);
					    events.trigger("bolero.login.ready");
				    }
			    });
		    },
		    register: function(e, attach, error){
			    if(bul.handlers.prevent){ return false; }
			    if(e){ e.preventDefault(); }
			    bul.flow = "register";
			    require(["bolero.form"], function(BoleroForm){
				    var $container = $forms.register.filter(".register.bolero-ajax-form-wrapper"),
					    data = dsbul.et_lists ? {et_lists: dsbul.et_lists.join(",")} : null,
					    bolero_form = new BoleroForm($container, null, data, { submitText: "Creating Account..." });
					bolero_form.load().done(function(response){
					    if(response !== false){
					        // Because the form was loaded via ajax we should re-attach it
					        bul.attach();
					    }else{
						    attach = attach || !bolero_form.settings.attached;
					    }
					    $forms.removeClass($forms.state).addClass("state--register");
					    $forms.header.register.addClass("active");
					    $forms.header.login.removeClass("active");
						var formSelector = "form#bolero-user-register, form.bolero-user-register, form#user-register-form, form.user-register-form";
						$forms.form = $forms.find(formSelector).andSelf().filter(formSelector);
					    $forms.social.find(".auth-action").text("Register");
						if(!error){ $forms.messages.hide(); }
						if(attach !== false){
							bul.handlers.form(bolero_form.$form);
							// If using AE connect validate using bolero_form and submit to AE before submitting locally.
							bul.attachForm(bolero_form);
							ga("send", "event", "Bolero Login", "opened", "register", null);
							$forms.form.on("grecaptcha.reset", function(){ if(window.grecaptcha){ grecaptcha.reset(); } });

							var $recaptcha = bolero_form.$form.find(".captcha .g-recaptcha");
							if($recaptcha.is(":empty")){
								var recaptcha_params = {
									sitekey: $recaptcha.attr("data-sitekey"),
									theme: $recaptcha.attr("data-theme"),
									type: $recaptcha.attr("data-type")
								};
								if(window.grecaptcha){ grecaptcha.render($recaptcha[0], recaptcha_params); }
							}
						}
				    });
			    });
		    },
		    ae_register_form: function(){
			    var $ae_reg_form = $(this),
				    formId = this.id;
			    require(["bolero.form"], function(BoleroForm){
				    var bolero_form = new BoleroForm($ae_reg_form, null, null, { useAjax:false, ajaxSubmit:false });
				    function attach_register_form(){
					    function ae_submit(ae_user, type, sso) {
						    if(type === "init" || sso === true){ return; }//|| sso === true
						    var $ae_user = bolero_form.$form.find("input[name=ae_user]");
						    $ae_user.val(JSON.stringify(ae_user));
						    dbae.remove_ae_field_mappings(bolero_form.$form);
						    bolero_form.submit();
					    }
					    events.on("ae_login", ae_submit).replay("ae_login", ae_submit);
					    events.on("ae_user", ae_submit).replay("ae_user", ae_submit);
					    bolero_form.$formSubmit.on("click", function(){
						    $forms.form = bolero_form.$form;
						    bul.flow = (formId.indexOf("register") >= 0) ? "register" : "login";
					    });
				    }
				    bul.handlers.form(bolero_form.$form);
				    if(formId !== "ae-required-fields"){
					    bul.attachForm(bolero_form);
					    events.on("ae_ready", attach_register_form).replay("ae_ready", attach_register_form);
				    }else{
					    $forms.form = bolero_form.$form;
				    }
			    });
		    },
		    password: function(e, error){
			    if(bul.handlers.prevent){ return false; }
			    if(e){ e.preventDefault(); }
			    require(["bolero.form"], function(BoleroForm){
				    var $container = $forms.password.filter(".password").find(".bolero-ajax-form-wrapper"),
					    bolero_form = new BoleroForm($container, null, null, { submitText: "Sending Email..." });
				    bolero_form.load().done(function(response){
					    if(response !== false){
					        // Because the form was loaded via ajax we should re-attach it
					        bul.attach();
						    ga("send", "event", "Bolero Login", "opened", "password", null);
					    }
					    $forms.removeClass($forms.state).addClass("state--password");
					    if(!error){ $forms.messages.hide(); }
					    $forms.form = bolero_form.$form;
					    if(this.xhr){
						    bul.handlers.form($forms.form);
					    }
				    });
			    });
		    },
		    required_fields: function(user, type, sso){
			    if(type === "init" || sso === true || !bul.isBlock){ return; }
			    /*if(dbae.remoteOnly){
				    if(bul.opened){ bul.close(); }
				    return bul.events.remote_login(user);
			    }*/
			    var $container = $forms.required_fields || $('<div class="required-fields ae-form" style="display:none"></div>'),
				    options = { remoteOnly: dbae.remoteOnly };
			    if(!$forms.required_fields){
				    $forms.forms.append($container);
				    $forms.required_fields = $container;
			    }
			    require(["bolero.form"], function(BoleroForm){
				    var bolero_form = new BoleroForm($container, 'ae_required_fields', {ae_user: JSON.stringify(user) });
				    bolero_form.load().done(function(response){
					    if(response === false){
						    // The form has already been loaded, no ajax request needed.
						    if(!bul.required_fields_complete && !bul.opened){
							    // If the user hasn't satisfied all required fields ask them again;
							    bul.handlers.show($container, 'required-fields');
							    bul.open(false);
						    }else{
							    // otherwise, continue with login / update.
							    if(!bul.opened && !bul.inline_optins){
								    bul.actions.clear_subscriptions();
							    }
							    bul.actions.login(user, type, options);
						    }
						    return;
					    }

					    var $form = bolero_form.$form,
						    $required_fields = $form.find('input[name=required_fields]'),
						    has_required_fields = $required_fields.val() !== "",
						    required_fields_exacttarget = dsbul.required_fields_exacttarget,
						    country = user.data.CountryCode;

						bul.required_fields_complete = false;
					    var country_optout = dsbul.optout_default;
					    if(!country && user.data.GeoCountry){ country = user.data.GeoCountry; }
					    if(dsbul.casl || country === "CA" || user.data.Country === "Canada"){
						    bul.actions.casl("casl", true);
					    }else if(dsbul.optout_default || country !== "US" || user.data.Country !== "United States"){
						    bul.actions.casl("nonUS", true);
					    }
					    if(country){
						    events.trigger("country.detect", [country]);
					    }
					    country_optout = (dsbul.optout_default !== country_optout);
					    required_fields_exacttarget = bul.handlers.required_fields_et($form, country_optout);

					    //If the required fields screen is triggered, open the modal.
					    if(!has_required_fields){
						    // If already logged in then we're all set.
						    dbae.updateForm($forms.form);
						    if(required_fields_exacttarget > 0){
							    $form.find("#ae-required-fields-submit").val("Continue");
							    if(dsbul.required_fields_subscribe_cta){
								    $form.find("header > h3").text(dsbul.required_fields_email_cta);
								    $form.find("header > .description").hide();
							    }
							    $form.on("submit", function(e){
								    e.preventDefault();
								    e.stopImmediatePropagation();
								    $form.addClass("state--loading");
								    bul.required_fields_complete = true;
								    bul.actions.login(user, type, options);
							    });
							    if(!bul.opened){ bul.opened_et = true; }
							    bul.handlers.show($container, 'required-fields');
							    ga("send", "event", "Bolero Login", "opened", "required_fields", null);
						    }else{
							    if(!bul.opened && !bul.inline_optins){
								    // Uncheck ET mailing lists if the user hasn't seen the login form yet
								    // so that we don't blindly subscribe them.
								    bul.actions.clear_subscriptions();
							    }
							    bul.required_fields_complete = true;
							    bul.actions.login(user, type, options);
							    ga("send", "event", "Bolero Login", "skip", "required_fields", null);
						    }
						    return;
					    }
					    // ### If there are some required fields left
					    events.trigger("bolero.required_fields", [user, type, sso]);

					    // Show the form
					    if(!bul.opened){
						    bul.opened_required_fields = true;
						    bul.open(false);
					    }
					    bolero_form.$container.show();
					    bul.handlers.form($form);
					    bul.handlers.show($container, 'required-fields');
					    //##### Validate the form
					    function validate(e){
						    bolero_form.validate();
						    return false;
					    }
					    function ae_continue(user, state){
						    // use the updated user from AE
						    aeJS.events.onUser.removeHandler(ae_continue);
						    aeJS.events.onLogin.addHandler(bul.handlers.required_fields);
						    aeJS.events.onUser.addHandler(bul.handlers.required_fields);
						    bul.handlers.prevent = false;
						    bolero_form.$container.hide();
						    //update the form fields with AE user data
						    dbae.updateForm($forms.form);
						    bul.handlers[bul.flow](null, false);
						    bolero_form.delete();
						    bul.handlers.prevent = true;
						    bul.actions.login(user, type, options);
					    }
					    $form.on("submit", validate);
					    // Once the form has been validated server-side, submit to AE
					    bolero_form.$form.on("validated", function(){
						    $form.off("submit", validate);
						    $form.attr("data-ae-register-form", $forms.form.attr("data-ae-register-form"));
						    dbae.map_ae_fields($form);
						    aeJS.trigger.attach($form[0]);
						    // and continue with login/registration.
						    aeJS.events.onLogin.removeHandler(bul.handlers.required_fields);
						    aeJS.events.onUser.removeHandler(bul.handlers.required_fields);
						    aeJS.events.onUser.addHandler(ae_continue);
						    aeJS.trigger.submit($form[0]);
					    });
					    ga("send", "event", "Bolero Login", "opened", "required_fields", null);
				    });
			    });
		    },
		    required_fields_et: function($form, country_optout){
			    var subscriptionCount = 0,
				    level = dsbul.required_fields_exacttarget;
			    // ### Copy the ET required fields as part of the required_fields form
			    var $et_lists = $forms.form.find(".et-lists.form-checkboxes").closest(".form-item-lists").clone(),
				    $et_list_items = $et_lists.find("input"),
				    $et_disclaimer = $forms.form.find(".et-disclaimer").clone();

			    $et_list_items.each(function(){
				    var $et_list = $(this),
					    $form_et_list = $forms.form.find('input.et-lists[name="'+$et_list.attr("name")+'"]'),
					    listId = $et_list.val(),
					    isChecked = $et_list.is(":checked"),
					    isOptedOut = localStorage.getItem("et_list_optout_"+listId) === "1",
					    isSubscribed = localStorage.getItem("et_list_subscribed_"+listId) === "1";
				    $et_list.removeAttr("id");
				    if(isChecked && (bul.opened || bul.inline_optins) || isSubscribed || isOptedOut && level !== 3){
					    // We can skip the required fields screen if the user has subscribed or opted out of lists.
					    subscriptionCount++;
				    }
				    if(level === 3 && !isSubscribed && !bul.et_optout && !dsbul.optout_default){
					    $et_list.prop("checked", true);
					    $form_et_list.prop("checked", true);
				    }
				    $et_list.on("click", function(){ $form_et_list.click();});
				    $et_list.siblings("label").on("click", function(){
					    // Cloned labels retain original for="id", just need to update checked status.
					    setTimeout(function(){$et_list.prop("checked", $form_et_list.prop("checked"));},0);
				    });
			    });
			    if(dsbul.optout_default && country_optout && dsbul.required_fields_casl && level < 1){
				    // For detected non-US countries we require opt-in and should prompt for mailinglists again.
				    level = 1;
			    }
			    if( bul.et_optout || level === 1  && subscriptionCount > 0 ||
				    level >= 2 && subscriptionCount === $et_list_items.length ){
				    dsbul.required_fields_exacttarget = level = 0;
			    }
			    $form.find(".form-actions").before($et_lists).before($et_disclaimer);
			    return level;
		    },
		    error: function(e, error, fatal){
			    if(error){
				    // force error.message to be interpreted as html
				    var $error = $($.parseHTML(error.message)),
					    error_message = error.message;

				    if($error.is("#messages")){ error_message = $error.children(".messages").html(); }
				    if($error.is(".messages")){ error_message = $error.html(); }
				    error_message = bul.handlers.custom_errors(error_message);

				    $forms.messages = $forms.find("#messages, .messages");
				    $forms.messages.empty().addClass("messages error messages--error").first().siblings("#messages, .messages").remove();
				    $forms.messages.html(error_message).show();

				    if(bul.isBlock){
					    // update links to trigger screen handlers
					    $forms.messages.find("a").each(function(){
						    var $link = $(this),
							    href = $link[0].href;
						    if(href.indexOf("/user/login", href.length - 11) !== -1){
							    $link.on("click", bul.handlers.login);
						    }else if(href.indexOf("/user/register", href.length - 14) !== -1){
							    $link.on("click", bul.handlers.register);
						    }else if(href.indexOf("/user/password", href.length - 14) !== -1){
							    $link.on("click", bul.handlers.password);
						    }
					    });
				    }

				    if(error.errors && (error.errors.ae_user) && $forms.form && $forms.form.get(0).id !== "ae-required-fields"){
				    // or form is validated
					    // If ae_user error then logout of AE so another attempt can be made.
					    aeJS.trigger.logout();
					    if(bul.isBlock){
						    aeJS.events.onLogin.addHandler(bul.handlers.required_fields);
						    aeJS.events.onUser.addHandler(bul.handlers.required_fields);
					    }
					    // re-attach Bolero form
					    require(["bolero.form"], function(BoleroForm){
						    var bolero_form = new BoleroForm($forms.form);
						    // Detach & re-attach form.
						    bul.detachForm(bolero_form);
						    bul.handlers[bul.flow](null, true, true);
						    $forms.messages.show();
					    });
				    }
					// Make sure the modal is displayed if needed.
				    if(!bul.opened){ bul.open(false); }

				    $error.children(".element-invisible").remove();
				    var error_text = $error.text();
				    if(typeof fatal !== "undefined"){
					    ga("send", "exception", {
						    appName: error.type || "Bolero Login",
						    exDescription:  error_text,
						    exFatal: fatal
					    });
				    }else{
					    ga("send", "event", error.errors.ae_user ? "AE Connect" : "Bolero Login", "error", error_text, null, {nonInteraction: 1});
				    }
			    }else{
				    $forms.messages.text("Unable to login, an error has occurred.").show();
			    }
		    },
		    custom_errors: function(message){
			    message = message.toLowerCase().replace(/\+/g, " ");
				switch(message){
					case "email account already exists with a different password":
						return 'An account with this e-mail address already exists with a different password. <a href="/user/password">Reset&nbsp;Your&nbsp;Password</a>';
					case "no account exists with those credentials.":
						return 'No account exists with that e-mail / password. <a href="/user/register">Create&nbsp;an&nbsp;Account</a> or <a href="/user/password">Reset&nbsp;Your&nbsp;Password</a>';
			  }
			  return message;
		    },
		    form: function($form){
			    $form.on("error", bul.handlers.error);
			    if( require.specified("IGA.common.webform") && Modernizr && Modernizr.inputtypes.date){
				    require(["IGA.common.webform"], function(Webform){
					    $form.find(".form-item-birthdate.form-type-date-text input").attr({
						    type: "date",
						    autocomplete: "bday",
						    placeholder: "mm/dd/yyyy",
						    required: null
					    });
					    $form.find(".form-type-date, .form-type-date-select, .form-type-date-text").each(Webform.dateInput);
				    });
			    }
				// CASL zipcode detection
			    var casl_match = _.debounce(function(){
				    var $zip = $(this), zip = $zip.val().toUpperCase();
				    if(zip.match(bul.casl_regex)){
					    bul.actions.casl("casl", true);
					    $zip.off("change", casl_match);
				    }
			    });
			    $form.find("input[name=zipcode]").on("change", casl_match);
		    },
		    show: function($form, state){
			    $forms.removeClass($forms.state).addClass("state--"+state);
			    $form.show();
			    bul.handlers.prevent = true;
			    $forms.messages.hide();
			    if(!bul.opened){ bul.open(); }
		    }
	    },
	    casl_regex: new RegExp(/[ABCEGHJKLMNPRSTVXY][0-9][ABCEGHJKLMNPRSTVWXYZ]\s?[0-9][ABCEGHJKLMNPRSTVWXYZ][0-9]/),
	    casl_message: '<p class="casl-message" ><br>** Emails will be sent by or on behalf of Universal Music Group 2220 Colorado Avenue, Santa Monica , CA 90404 (310) 865-4000. You may withdraw your consent at any time. See Privacy Policy at <a href="http://privacypolicy.umusic.com">http://privacypolicy.umusic.com</a>.</p>'
    };

	function mobile_detect(){ dsbul.isMobile = bul.isMobile = true; }
	events.on("ae_mobile_detect", mobile_detect).replay("ae_mobile_detect", mobile_detect);

    return bul;
});

// # Drupal Behaviors
(function($){
	"use strict";
	var $block = $("#block-bolero-user-login-user-login-modal"),
		dbae = Drupal.behaviors.ae_social_login,
		dsae = Drupal.settings.ae_social_login || { settings:{} },
		dsbul = Drupal.settings.bolero_user_login || {},
		dbbul = Drupal.behaviors.bolero_user_login = {
		login_selectors: "a.user-login.bolero-modal, a[href*='user/login'], a.user-login-link",
		ae_login_selectors: "a.ae-register-link[data-ae-register-link], a.ae-register-link[data-ae-login-link], a.ae-register-link[data-ae-auth-link]",
		// TODO figure out how to remove this...
		stopPropagation_selectors: "body.not-logged-in form.node-post-form .form-actions .form-submit",
		modal_selectors: function(){ return [dbbul.login_selectors, dbbul.stopPropagation_selectors].join(", "); },
		all_selectors: function(){ return [dbbul.login_selectors, dbbul.stopPropagation_selectors, dbbul.ae_login_selectors].join(", "); },
		// ## Attach Behavior
		attach:function(context, settings){
			if(context !== document){ dbbul.attachLinks(context); }

			$(dbbul.all_selectors(), context).once("bul-attach", function(){
				var $link = $(this),
					$node = $link.closest(".node[data-nid], .bolero-clearing-content, .clearing-caption"),
					isInline = $node.is(".node:not(.node--full), .bolero-clearing-content, .clearing-caption"),
					nid = $node.attr("data-nid"),
					title = $node.attr("data-title"),
					url = $node.attr("data-alias"),
					isMobile = dsae && dsae.settings? !dsae.settings.auth_window : false;
				// Update Login / Connect text
				require(["IGA.user"], function(user){
					if(user.uid){
						$link.addClass("state--connect");
						$link.find(".auth-action").text("Connect");
					}
				});

				//### Track login source node
				require(["bolero.user_login", "underscore", "IGA.events"], function(bul, _, events){
					isMobile = dsbul.isMobile;
					events.on("ae_mobile_detect", function(){ isMobile = true; });
					// TODO will this get fired with stopImmediatePropagation
					// TODO potential issue with ae_ready after attachLinks
					var provider;
					if($link.is(dbbul.ae_login_selectors)){
						provider = $link.attr("data-ae-register-link");
					}
					$link.on("click mousedown", function(){
						_.defer(function(){
							if(nid){ bul.data.nid = nid; }
							if(title){ bul.data.title = title; }
							if(provider){ bul.data.provider = provider; }
							if(url && isInline){
								bul.data.redirect_url = url;
								// For mobile, tell AE to redirect to the specified url.
								if(isMobile && aeJS){
									aeJS.settings.return_url = url;
									events.once("bolero.user_login.close", function(){
										dsbul.clear_return_url();
										events.off("ae_window", dsbul.clear_return_url);
									}).once("ae_window", function(state){
										if(state.state === "closed"){
											dsbul.clear_return_url();
											events.off("bolero.user_login.close", dsbul.clear_return_url);
										}
									});
								}
							}
						});
					});
				});
			});
		},
		clear_return_url: function(){ aeJS.settings.return_url = ""; },
		// ## Attach to login links
		attachLinks: function(context){
			// ### Attach Regular modal open links
			$(dbbul.login_selectors, context).once("bul", function(){
				var $link = $(this);
				$link.on("click", function(e){
					var cp = $link.attr("data-campaign");
					cp = cp ? cp : "user login";
					IGA.setConversion(cp);
					e.preventDefault();
					IGA.drupal.login();
				});
			});

			if(context === document && dbae){
				require(["IGA.events"], function(events){
					events.on("ae_user_cancelled", dbae.clearTriggeringElement);
				});
			}

			function openETModal($this, cp){
				var $lists = $this.closest(".bolero--login-buttons").siblings(".bolero-login-buttons--et-lists");
				require(["ExactTarget"], function(ET){
					// If opted out or closed then don't open the modal
					if(!ET.isSubscribedToLists($lists)){
						ET.modal.open(null, { campaign: cp });
					}
				});
			}

			// ### Attach to AE login links
			$(dbbul.ae_login_selectors, context).once("bul",function(){
				var $link = $(this), link = this, cp = $link.attr("data-campaign");

				$link.on("ae_login", function(e, $el, ae_user, type, sso){
					var remoteOnly = dbae.remoteOnly;
					require(["IGA.events"], function(events){
						function boleroLoginComplete(){
							events.trigger("element_ae_login",  [$el, ae_user, type, sso]);
							// ## Show Email opt-in modal after remote-only login.
							if($link.is("a[data-remote-only][data-exacttarget-optin]")){
								openETModal($link, cp);
							}
						}
						if(remoteOnly){
							events.once("bolero.remote_login", boleroLoginComplete).replay("bolero.remote_login", boleroLoginComplete);
						}else{
							boleroLoginComplete();
						}
					});
				});

				function ae_attach_link(){
					// Initialize the AE JS on this link if not initially on the page.
					if(context !== document){ aeJS.trigger.attach(link); }
					$link.on("click", function(){
						if(!$link.is("a[data-remote-only]")){
							cp = cp ? cp : "ae-register-link";
							IGA.setConversion(cp, true);
						}else{
							dbae.setRemoteOnly();
						}
						dbae.setTriggeringElement($link);
					});
					// move our click handler before the AE click handler.
					var _events = $._data($link[0], "events");
					_events.click.unshift(_events.click.pop());
				}

				require(["IGA.events"], function(events){
					events.on("ae_ready", ae_attach_link).replay("ae_ready", ae_attach_link);
				});
			});
		}
	};

	// Initialize links before $.ready
	dbbul.attachLinks(document);

	// # Initialize
	require(["jquery", "bolero.user_login", "IGA.events", "IGA.user", "googleanalytics"], function($, bul, events, user){
		function last_login_service(user){
			var service = null;
			for(var s in user.services){
				if(!service || user.services[s].LastLogin > service.LastLogin){
					service = user.services[s];
				}
			}
			return service;
		}

		// ## AE Login Analytics
		function ae_ready(){
			aeJS.events.onWindow.addHandler(function(state){
				if(state.state === "opened"){
					bul.data = {};
					ga("send", "event", "AE Connect", "opened", state.service, null);
				}else if(state.state === "closed"){
					var is_user_cancelled = !aeJS.user.services;
					if(!is_user_cancelled){
						var connected = false;
						for(var s in aeJS.user.services){
							var service = aeJS.user.services[s];
							if(service.Service.toLowerCase() === state.service){
								connected = true;
								break;
							}
						}
						if(!connected){ is_user_cancelled = true; }
					}
					if(is_user_cancelled){
						// If the window is closed and the user isn't connected, consider it an permission refusal.
						ga("send", "event", "AE Connect", "user_cancelled", state.service, null, { nonInteraction: false });
						events.trigger("ae_user_cancelled", [aeJS.user]);
					}
				}
			});
			aeJS.events.onFlow.addHandler(function(state){
				var action = state.step, label = null, ni = true;
				if(state.step === "error"){
					if(state.error.indexOf("denied" > 0)){
						action = "user_denied"; ni = false;
					}else{
						action = "error."+state.error;
					}
				}else if(state.step === "authenticate"){
					bul.ae_login_start = Date.now();//TODO mobile timing through redirect?
				}
				if(state.service){ label = state.service; }
				ga("send", "event", "AE Connect", action, label, null, { nonInteraction: ni });
			});
			aeJS.events.onLogout.addHandler(function(){
				ga("send", "event", "AE Connect", "logout", null, null);
			});

			function ae_login(user, type, sso){
				var service = last_login_service(user),
					provider = service ? service.Service : null;
				if(sso){
					//bul.setOptout({ $form: $("form#bolero-user-login") });
					ga("send", "event", "AE Connect", "sso", provider, null, { nonInteraction: true });
				}else{
					// login | register
					//TODO conversionPt as dimension5 / campaign
					ga("send", "event", "AE Connect", type, provider, null);
					if(bul.ae_login_start){
						ga('send', 'timing', 'Appreciation Engine', 'ae_login_'+service, Date.now() - bul.ae_login_start, 'AE');
					}
				}
				// Check if there is an element tracked as the source of this link.
				if(dbae){
					var $el = dbae.getTriggeringElement();
					if($el && $el.is(dbbul.ae_login_selectors)){ $el.trigger("login", [ $el, user, type, sso ]); }
				}
			}
			function ae_user(user, state){
				if(state === 'init' && IGA.user.uid && dsae.redirect_login){
					var service = last_login_service(user),
						provider = service ? service.Service : null,
						country = user.data.CountryCode;
					if(dsae.redirect_required_fields){
						var label = (dsae.redirect_required_fields === 'valid') ? 'skip' : 'opened';
						ga("send", "event", "AE Connect", "required_fields", label, null);
					}
					//TODO We can't determine login vs. registration
					ga("send", "event", "AE Connect", "login", provider, null);
					if(!country && user.data.GeoCountry){ country = user.data.GeoCountry; }
					if(country){ events.trigger("country.detect", [country]); }

					events.trigger("login", [IGA.user, { ae_user: user, provider: provider, redirect: true }]);
				}
			}

			events.on("ae_login", ae_login).replay("ae_login", ae_login);
			events.on("ae_user", ae_user).replay("ae_user", ae_user);
		}
		events.on("ae_ready", ae_ready).replay("ae_ready", ae_ready);
		bul.init();

		events.on("optout.default", bul.actions.casl).replay("optout.default", bul.actions.casl);
	});

	if($block.length){
		// If the user clicks login before initialization re-trigger when ready.
		IGA.drupal.login = function(){
			require(["bolero.user_login"], function(BoleroLogin){
				BoleroLogin.init().open();
			});
		};
	}
})(jQuery);
;
var threeSixtyPlayer,ThreeSixtyPlayer;!function(a){function t(){var t=this,e=this,n=soundManager,i=navigator.userAgent,s=i.match(/msie/i),o=i.match(/opera/i),d=i.match(/safari/i),r=i.match(/chrome/i),l=(i.match(/firefox/i),i.match(/ipad|iphone/i)),u="undefined"==typeof a.G_vmlCanvasManager&&"undefined"!=typeof document.createElement("canvas").getContext("2d"),c=o||r?359.9:360,m=navigator.userAgent.match(/msie [678]/i)?1:2;this.excludeClass="threesixty-exclude",this.links=[],this.sounds=[],this.soundsByURL=[],this.indexByURL=[],this.lastSound=null,this.lastTouchedSound=null,this.soundCount=0,this.oUITemplate=null,this.oUIImageMap=null,this.vuMeter=null,this.callbackCount=0,this.peakDataHistory=[],this.config={playNext:!1,autoPlay:!1,allowMultiple:!1,loadRingColor:"#ccc",playRingColor:"#000",backgroundRingColor:"#eee",segmentRingColor:"rgba(255,255,255,0.33)",segmentRingColorAlt:"rgba(0,0,0,0.1)",loadRingColorMetadata:"#ddd",playRingColorMetadata:"rgba(128,192,256,0.9)",circleDiameter:null,circleRadius:null,animDuration:500,animTransition:a.Animator.tx.bouncy,showHMSTime:!1,scaleFont:!0,useWaveformData:!1,waveformDataColor:"#0099ff",waveformDataDownsample:3,waveformDataOutside:!1,waveformDataConstrain:!1,waveformDataLineRatio:.64,useEQData:!1,eqDataColor:"#339933",eqDataDownsample:4,eqDataOutside:!0,eqDataLineRatio:.54,usePeakData:!0,peakDataColor:"#ff33ff",peakDataOutside:!0,peakDataLineRatio:.5,useAmplifier:!0,fontSizeMax:null,scaleArcWidth:1,useFavIcon:!1},this.css={sDefault:"sm2_link",sBuffering:"sm2_buffering",sPlaying:"sm2_playing",sPaused:"sm2_paused"},this.addEventHandler="undefined"!=typeof a.addEventListener?function(a,t,e){return a.addEventListener(t,e,!1)}:function(a,t,e){a.attachEvent("on"+t,e)},this.removeEventHandler="undefined"!=typeof a.removeEventListener?function(a,t,e){return a.removeEventListener(t,e,!1)}:function(a,t,e){return a.detachEvent("on"+t,e)},this.hasClass=function(a,t){return"undefined"!=typeof a.className?a.className.match(new RegExp("(\\s|^)"+t+"(\\s|$)")):!1},this.addClass=function(a,e){return a&&e&&!t.hasClass(a,e)?void(a.className=(a.className?a.className+" ":"")+e):!1},this.removeClass=function(a,e){return a&&e&&t.hasClass(a,e)?void(a.className=a.className.replace(new RegExp("( "+e+")|("+e+")","g"),"")):!1},this.getElementsByClassName=function(a,e,n){var i,s,o=n||document,d=[],r=[];if("undefined"!=typeof e&&"string"!=typeof e)for(i=e.length;i--;)r&&r[e[i]]||(r[e[i]]=o.getElementsByTagName(e[i]));else r=e?o.getElementsByTagName(e):o.all||o.getElementsByTagName("*");if("string"!=typeof e)for(i=e.length;i--;)for(s=r[e[i]].length;s--;)t.hasClass(r[e[i]][s],a)&&d.push(r[e[i]][s]);else for(i=0;i<r.length;i++)t.hasClass(r[i],a)&&d.push(r[i]);return d},this.getParentByNodeName=function(a,t){if(!a||!t)return!1;for(t=t.toLowerCase();a.parentNode&&t!==a.parentNode.nodeName.toLowerCase();)a=a.parentNode;return a.parentNode&&t===a.parentNode.nodeName.toLowerCase()?a.parentNode:null},this.getParentByClassName=function(a,e){if(!a||!e)return!1;for(;a.parentNode&&!t.hasClass(a.parentNode,e);)a=a.parentNode;return a.parentNode&&t.hasClass(a.parentNode,e)?a.parentNode:null},this.getSoundByURL=function(a){return"undefined"!=typeof t.soundsByURL[a]?t.soundsByURL[a]:null},this.isChildOfNode=function(a,t){if(!a||!a.parentNode)return!1;t=t.toLowerCase();do a=a.parentNode;while(a&&a.parentNode&&a.nodeName.toLowerCase()!==t);return a&&a.nodeName.toLowerCase()===t?a:null},this.isChildOfClass=function(a,e){if(!a||!e)return!1;for(;a.parentNode&&!t.hasClass(a,e);)a=t.findParent(a);return t.hasClass(a,e)},this.findParent=function(a){if(!a||!a.parentNode)return!1;if(a=a.parentNode,2===a.nodeType)for(;a&&a.parentNode&&2===a.parentNode.nodeType;)a=a.parentNode;return a},this.getStyle=function(t,e){try{if(t.currentStyle)return t.currentStyle[e];if(a.getComputedStyle)return document.defaultView.getComputedStyle(t,null).getPropertyValue(e)}catch(n){}return null},this.findXY=function(a){var t=0,e=0;do t+=a.offsetLeft,e+=a.offsetTop;while(a=a.offsetParent);return[t,e]},this.getMouseXY=function(e){return e=e?e:a.event,l&&e.touches&&(e=e.touches[0]),e.pageX||e.pageY?[e.pageX,e.pageY]:e.clientX||e.clientY?[e.clientX+t.getScrollLeft(),e.clientY+t.getScrollTop()]:void 0},this.getScrollLeft=function(){return document.body.scrollLeft+document.documentElement.scrollLeft},this.getScrollTop=function(){return document.body.scrollTop+document.documentElement.scrollTop},this.events={play:function(){e.removeClass(this._360data.oUIBox,this._360data.className),this._360data.className=e.css.sPlaying,e.addClass(this._360data.oUIBox,this._360data.className),t.fanOut(this)},stop:function(){e.removeClass(this._360data.oUIBox,this._360data.className),this._360data.className="",t.fanIn(this)},pause:function(){e.removeClass(this._360data.oUIBox,this._360data.className),this._360data.className=e.css.sPaused,e.addClass(this._360data.oUIBox,this._360data.className)},resume:function(){e.removeClass(this._360data.oUIBox,this._360data.className),this._360data.className=e.css.sPlaying,e.addClass(this._360data.oUIBox,this._360data.className)},finish:function(){var a;e.removeClass(this._360data.oUIBox,this._360data.className),this._360data.className="",this._360data.didFinish=!0,t.fanIn(this),e.config.playNext&&(a=e.indexByURL[this._360data.oLink.href]+1,a<e.links.length&&e.handleClick({target:e.links[a]}))},whileloading:function(){this.paused&&t.updatePlaying.apply(this)},whileplaying:function(){t.updatePlaying.apply(this),this._360data.fps++},bufferchange:function(){this.isBuffering?e.addClass(this._360data.oUIBox,e.css.sBuffering):e.removeClass(this._360data.oUIBox,e.css.sBuffering)}},this.stopEvent=function(t){return"undefined"!=typeof t&&"undefined"!=typeof t.preventDefault?t.preventDefault():"undefined"!=typeof a.event&&"undefined"!=typeof a.event.returnValue&&(a.event.returnValue=!1),!1},this.getTheDamnLink=s?function(t){return t&&t.target?t.target:a.event.srcElement}:function(a){return a.target},this.handleClick=function(e){if(e.button>1)return!0;var i,s,o,d,r,l,u,c=t.getTheDamnLink(e);return("a"===c.nodeName.toLowerCase()||(c=t.isChildOfNode(c,"a")))&&t.isChildOfClass(c,"ui360")?(s=c.getAttribute("href"),c.href&&n.canPlayLink(c)&&!t.hasClass(c,t.excludeClass)?(n._writeDebug("handleClick()"),o=c.href,d=t.getSoundByURL(o),d?d===t.lastSound?d.togglePause():(d.togglePause(),n._writeDebug("sound different than last sound: "+t.lastSound.id),!t.config.allowMultiple&&t.lastSound&&t.stopSound(t.lastSound)):(r=c.parentNode,l=t.getElementsByClassName("ui360-vis","div",r.parentNode).length,d=n.createSound({id:"ui360Sound"+t.soundCount++,url:o,onplay:t.events.play,onstop:t.events.stop,onpause:t.events.pause,onresume:t.events.resume,onfinish:t.events.finish,onbufferchange:t.events.bufferchange,type:c.type||null,whileloading:t.events.whileloading,whileplaying:t.events.whileplaying,useWaveformData:l&&t.config.useWaveformData,useEQData:l&&t.config.useEQData,usePeakData:l&&t.config.usePeakData}),u=parseInt(t.getElementsByClassName("sm2-360ui","div",r)[0].offsetWidth*m,10),i=t.getElementsByClassName("sm2-canvas","canvas",r),d._360data={oUI360:t.getParentByClassName(c,"ui360"),oLink:c,className:t.css.sPlaying,oUIBox:t.getElementsByClassName("sm2-360ui","div",r)[0],oCanvas:i[i.length-1],oButton:t.getElementsByClassName("sm2-360btn","span",r)[0],oTiming:t.getElementsByClassName("sm2-timing","div",r)[0],oCover:t.getElementsByClassName("sm2-cover","div",r)[0],circleDiameter:u,circleRadius:u/2,lastTime:null,didFinish:null,pauseCount:0,radius:0,fontSize:1,fontSizeMax:t.config.fontSizeMax,scaleFont:l&&t.config.scaleFont,showHMSTime:l,amplifier:l&&t.config.usePeakData?.9:1,radiusMax:.175*u,width:0,widthMax:.4*u,lastValues:{bytesLoaded:0,bytesTotal:0,position:0,durationEstimate:0},animating:!1,oAnim:new a.Animator({duration:t.config.animDuration,transition:t.config.animTransition,onComplete:function(){}}),oAnimProgress:function(a){var e=this;e._360data.radius=parseInt(e._360data.radiusMax*e._360data.amplifier*a,10),e._360data.width=parseInt(e._360data.widthMax*e._360data.amplifier*a,10),e._360data.scaleFont&&null!==e._360data.fontSizeMax&&(e._360data.oTiming.style.fontSize=parseInt(Math.max(1,e._360data.fontSizeMax*a),10)+"px",e._360data.oTiming.style.opacity=a),(e.paused||0===e.playState||0===e._360data.lastValues.bytesLoaded||0===e._360data.lastValues.position)&&t.updatePlaying.apply(e)},fps:0},"undefined"!=typeof t.Metadata&&t.getElementsByClassName("metadata","div",d._360data.oUI360).length&&(d._360data.metadata=new t.Metadata(d,t)),d._360data.scaleFont&&null!==d._360data.fontSizeMax&&(d._360data.oTiming.style.fontSize="1px"),d._360data.oAnim.addSubject(d._360data.oAnimProgress,d),t.refreshCoords(d),t.updatePlaying.apply(d),t.soundsByURL[o]=d,t.sounds.push(d),!t.config.allowMultiple&&t.lastSound&&t.stopSound(t.lastSound),d.play()),t.lastSound=d,"undefined"!=typeof e&&"undefined"!=typeof e.preventDefault?e.preventDefault():"undefined"!=typeof a.event&&(a.event.returnValue=!1),!1):!0):!0},this.fanOut=function(e){var n=e;return 1===n._360data.animating?!1:(n._360data.animating=0,soundManager._writeDebug("fanOut: "+n.id+": "+n._360data.oLink.href),n._360data.oAnim.seekTo(1),void a.setTimeout(function(){n._360data.animating=0},t.config.animDuration+20))},this.fanIn=function(e){var n=e;return-1===n._360data.animating?!1:(n._360data.animating=-1,soundManager._writeDebug("fanIn: "+n.id+": "+n._360data.oLink.href),n._360data.oAnim.seekTo(0),void a.setTimeout(function(){n._360data.didFinish=!1,n._360data.animating=0,t.resetLastValues(n)},t.config.animDuration+20))},this.resetLastValues=function(a){a._360data.lastValues.position=0},this.refreshCoords=function(a){a._360data.canvasXY=t.findXY(a._360data.oCanvas),a._360data.canvasMid=[a._360data.circleRadius,a._360data.circleRadius],a._360data.canvasMidXY=[a._360data.canvasXY[0]+a._360data.canvasMid[0],a._360data.canvasXY[1]+a._360data.canvasMid[1]]},this.stopSound=function(a){soundManager._writeDebug("stopSound: "+a.id),soundManager.stop(a.id),l||soundManager.unload(a.id)},this.buttonClick=function(e){var n=e?e.target?e.target:e.srcElement:a.event.srcElement;return t.handleClick({target:t.getParentByClassName(n,"sm2-360ui").nextSibling}),!1},this.buttonMouseDown=function(a){return l?t.addEventHandler(document,"touchmove",t.mouseDown):document.onmousemove=function(a){t.mouseDown(a)},t.stopEvent(a),!1},this.mouseDown=function(e){if(!l&&e.button>1)return!0;if(!t.lastSound)return t.stopEvent(e),!1;var n,i,s,o=e?e:a.event;return l&&o.touches&&(o=o.touches[0]),n=o.target||o.srcElement,i=t.getSoundByURL(t.getElementsByClassName("sm2_link","a",t.getParentByClassName(n,"ui360"))[0].href),t.lastTouchedSound=i,t.refreshCoords(i),s=i._360data,t.addClass(s.oUIBox,"sm2_dragging"),s.pauseCount=t.lastTouchedSound.paused?1:0,t.mmh(e?e:a.event),l?(t.removeEventHandler(document,"touchmove",t.mouseDown),t.addEventHandler(document,"touchmove",t.mmh),t.addEventHandler(document,"touchend",t.mouseUp)):(document.onmousemove=t.mmh,document.onmouseup=t.mouseUp),t.stopEvent(e),!1},this.mouseUp=function(){var a=t.lastTouchedSound._360data;t.removeClass(a.oUIBox,"sm2_dragging"),0===a.pauseCount&&t.lastTouchedSound.resume(),l?(t.removeEventHandler(document,"touchmove",t.mmh),t.removeEventHandler(document,"touchend",t.mouseUP)):(document.onmousemove=null,document.onmouseup=null)},this.mmh=function(e){"undefined"==typeof e&&(e=a.event);var n=t.lastTouchedSound,i=t.getMouseXY(e),s=i[0],o=i[1],d=s-n._360data.canvasMidXY[0],r=o-n._360data.canvasMidXY[1],l=Math.floor(c-(t.rad2deg(Math.atan2(d,r))+180));return n.setPosition(n.durationEstimate*(l/c)),t.stopEvent(e),!1},this.drawSolidArc=function(a,e,n,i,s,r,l){var u,c,m,f,h=a;h.getContext&&(u=h.getContext("2d")),a=u,l||t.clearCanvas(h),e&&(u.fillStyle=e),a.beginPath(),isNaN(s)&&(s=0),c=n-i,m=o||d,(!m||m&&n>0)&&(a.arc(0,0,n,r,s,!1),f=t.getArcEndpointCoords(c,s),a.lineTo(f.x,f.y),a.arc(0,0,c,s,r,!0),a.closePath(),a.fill())},this.getArcEndpointCoords=function(a,t){return{x:a*Math.cos(t),y:a*Math.sin(t)}},this.deg2rad=function(a){return a*Math.PI/180},this.rad2deg=function(a){return 180*a/Math.PI},this.getTime=function(a,t){var e=Math.floor(a/1e3),n=Math.floor(e/60),i=e-60*n;return t?n+":"+(10>i?"0"+i:i):{min:n,sec:i}},this.clearCanvas=function(a){var t,e,n=a,i=null;n.getContext&&(i=n.getContext("2d")),i&&(t=n.offsetWidth,e=n.offsetHeight,i.clearRect(-(t/2),-(e/2),t,e))},this.updatePlaying=function(){var a=this._360data.showHMSTime?t.getTime(this.position,!0):parseInt(this.position/1e3,10),e=t.config.scaleArcWidth;this.bytesLoaded&&(this._360data.lastValues.bytesLoaded=this.bytesLoaded,this._360data.lastValues.bytesTotal=this.bytesTotal),this.position&&(this._360data.lastValues.position=this.position),this.durationEstimate&&(this._360data.lastValues.durationEstimate=this.durationEstimate),t.drawSolidArc(this._360data.oCanvas,t.config.backgroundRingColor,this._360data.width,this._360data.radius*e,t.deg2rad(c),!1),t.drawSolidArc(this._360data.oCanvas,this._360data.metadata?t.config.loadRingColorMetadata:t.config.loadRingColor,this._360data.width,this._360data.radius*e,t.deg2rad(c*(this._360data.lastValues.bytesLoaded/this._360data.lastValues.bytesTotal)),0,!0),0!==this._360data.lastValues.position&&t.drawSolidArc(this._360data.oCanvas,this._360data.metadata?t.config.playRingColorMetadata:t.config.playRingColor,this._360data.width,this._360data.radius*e,t.deg2rad(1===this._360data.didFinish?c:c*(this._360data.lastValues.position/this._360data.lastValues.durationEstimate)),0,!0),this._360data.metadata&&this._360data.metadata.events.whileplaying(),a!==this._360data.lastTime&&(this._360data.lastTime=a,this._360data.oTiming.innerHTML=a),(this.instanceOptions.useWaveformData||this.instanceOptions.useEQData)&&u&&t.updateWaveform(this),t.config.useFavIcon&&t.vuMeter&&t.vuMeter.updateVU(this)},this.updateWaveform=function(a){if(!t.config.useWaveformData&&!t.config.useEQData||!n.features.waveformData&&!n.features.eqData)return!1;if(!a.waveformData.left.length&&!a.eqData.length&&!a.peakData.left)return!1;var e,i,s,o,d,r,l,u,c,m,f,h,g,p,v,y,_=(a._360data.oCanvas.getContext("2d"),parseInt(a._360data.circleDiameter/2,10)),C=_/2;if(t.config.useWaveformData)for(o=t.config.waveformDataDownsample,o=Math.max(1,o),d=256,r=d/o,l=0,u=0,c=null,m=t.config.waveformDataOutside?1:t.config.waveformDataConstrain?.5:.565,C=t.config.waveformDataOutside?.7:.75,f=t.deg2rad(360/r*t.config.waveformDataLineRatio),e=0;d>e;e+=o)l=t.deg2rad(360*(e/r*1/o)),u=l+f,c=a.waveformData.left[e],0>c&&t.config.waveformDataConstrain&&(c=Math.abs(c)),t.drawSolidArc(a._360data.oCanvas,t.config.waveformDataColor,a._360data.width*m*(2-t.config.scaleArcWidth),a._360data.radius*C*1.25*c,u,l,!0);if(t.config.useEQData)for(o=t.config.eqDataDownsample,h=0,o=Math.max(1,o),g=192,r=g/o,m=t.config.eqDataOutside?1:.565,s=t.config.eqDataOutside?-1:1,C=t.config.eqDataOutside?.5:.75,l=0,u=0,f=t.deg2rad(360/r*t.config.eqDataLineRatio),p=t.deg2rad(1===a._360data.didFinish?360:360*(a._360data.lastValues.position/a._360data.lastValues.durationEstimate)),i=0,v=0,e=0;g>e;e+=o)l=t.deg2rad(360*(e/g)),u=l+f,t.drawSolidArc(a._360data.oCanvas,u>p?t.config.eqDataColor:t.config.playRingColor,a._360data.width*m,a._360data.radius*C*a.eqData.left[e]*s,u,l,!0);if(t.config.usePeakData&&!a._360data.animating){for(y=a.peakData.left||a.peakData.right,g=3,e=0;g>e;e++)y=y||a.eqData[e];a._360data.amplifier=t.config.useAmplifier?.9+.1*y:1,a._360data.radiusMax=.175*a._360data.circleDiameter*a._360data.amplifier,a._360data.widthMax=.4*a._360data.circleDiameter*a._360data.amplifier,a._360data.radius=parseInt(a._360data.radiusMax*a._360data.amplifier,10),a._360data.width=parseInt(a._360data.widthMax*a._360data.amplifier,10)}},this.getUIHTML=function(a){return['<canvas class="sm2-canvas" width="'+a+'" height="'+a+'"></canvas>',' <span class="sm2-360btn sm2-360btn-default"></span>',' <div class="sm2-timing'+(navigator.userAgent.match(/safari/i)?" alignTweak":"")+'"></div>',' <div class="sm2-cover"></div>']},this.uiTest=function(a){var e,n,i,s,o,d,r,l,u,c=document.createElement("div");return c.className="sm2-360ui",e=document.createElement("div"),e.className="ui360"+(a?" "+a:""),n=e.appendChild(c.cloneNode(!0)),e.style.position="absolute",e.style.left="-9999px",i=document.body.appendChild(e),s=n.offsetWidth*m,o=t.getUIHTML(s),n.innerHTML=o[1]+o[2]+o[3],d=parseInt(s,10),r=parseInt(d/2,10),u=t.getElementsByClassName("sm2-timing","div",i)[0],l=parseInt(t.getStyle(u,"font-size"),10),isNaN(l)&&(l=null),e.parentNode.removeChild(e),o=e=n=i=null,{circleDiameter:d,circleRadius:r,fontSizeMax:l}},this.init=function(){n._writeDebug("threeSixtyPlayer.init()");var e,i,o,d,r,u,c,f,h,g,p,v,y,_,C,D=t.getElementsByClassName("ui360","div"),M=[],N=!1,T=0;for(e=0,i=D.length;i>e;e++)M.push(D[e].getElementsByTagName("a")[0]),D[e].style.backgroundImage="none";for(t.oUITemplate=document.createElement("div"),t.oUITemplate.className="sm2-360ui",t.oUITemplateVis=document.createElement("div"),t.oUITemplateVis.className="sm2-360ui",h=t.uiTest(),t.config.circleDiameter=h.circleDiameter,t.config.circleRadius=h.circleRadius,g=t.uiTest("ui360-vis"),t.config.fontSizeMax=g.fontSizeMax,t.oUITemplate.innerHTML=t.getUIHTML(t.config.circleDiameter).join(""),t.oUITemplateVis.innerHTML=t.getUIHTML(g.circleDiameter).join(""),e=0,i=M.length;i>e;e++)!n.canPlayLink(M[e])||t.hasClass(M[e],t.excludeClass)||t.hasClass(M[e],t.css.sDefault)||(t.addClass(M[e],t.css.sDefault),t.links[T]=M[e],t.indexByURL[M[e].href]=T,T++,N=t.hasClass(M[e].parentNode,"ui360-vis"),c=(N?g:h).circleDiameter,f=(N?g:h).circleRadius,p=M[e].parentNode.insertBefore((N?t.oUITemplateVis:t.oUITemplate).cloneNode(!0),M[e]),s&&"undefined"!=typeof a.G_vmlCanvasManager?(y=M[e].parentNode,_=document.createElement("canvas"),_.className="sm2-canvas",C="sm2_canvas_"+e+(new Date).getTime(),_.id=C,_.width=c,_.height=c,p.appendChild(_),a.G_vmlCanvasManager.initElement(_),d=document.getElementById(C),o=d.parentNode.getElementsByTagName("canvas"),o.length>1&&(d=o[o.length-1])):d=M[e].parentNode.getElementsByTagName("canvas")[0],m>1&&t.addClass(d,"hi-dpi"),u=t.getElementsByClassName("sm2-cover","div",M[e].parentNode)[0],v=M[e].parentNode.getElementsByTagName("span")[0],t.addEventHandler(v,"click",t.buttonClick),l?t.addEventHandler(u,"touchstart",t.mouseDown):t.addEventHandler(u,"mousedown",t.mouseDown),r=d.getContext("2d"),r.translate(f,f),r.rotate(t.deg2rad(-90)));T>0&&(t.addEventHandler(document,"click",t.handleClick),t.config.autoPlay&&t.handleClick({target:t.links[0],preventDefault:function(){}})),n._writeDebug("threeSixtyPlayer.init(): Found "+T+" relevant items."),t.config.useFavIcon&&"undefined"!=typeof this.VUMeter&&(this.vuMeter=new this.VUMeter(this))}}t.prototype.VUMeter=function(a){var t=a,e=this,n=document.getElementsByTagName("head")[0],i=navigator.userAgent.match(/opera/i),s=navigator.userAgent.match(/firefox/i);this.vuMeterData=[],this.vuDataCanvas=null,this.setPageIcon=function(a){if(!t.config.useFavIcon||!t.config.usePeakData||!a)return!1;var e=document.getElementById("sm2-favicon");e&&(n.removeChild(e),e=null),e||(e=document.createElement("link"),e.id="sm2-favicon",e.rel="shortcut icon",e.type="image/png",e.href=a,document.getElementsByTagName("head")[0].appendChild(e))},this.resetPageIcon=function(){if(!t.config.useFavIcon)return!1;var a=document.getElementById("favicon");a&&(a.href="/favicon.ico")},this.updateVU=function(a){soundManager.flashVersion>=9&&t.config.useFavIcon&&t.config.usePeakData&&e.setPageIcon(e.vuMeterData[parseInt(16*a.peakData.left,10)][parseInt(16*a.peakData.right,10)])},this.createVUData=function(){var a=0,t=0,n=e.vuDataCanvas.getContext("2d"),i=n.createLinearGradient(0,16,0,0),s=n.createLinearGradient(0,16,0,0),o="rgba(0,0,0,0.2)";for(i.addColorStop(0,"rgb(0,192,0)"),i.addColorStop(.3,"rgb(0,255,0)"),i.addColorStop(.625,"rgb(255,255,0)"),i.addColorStop(.85,"rgb(255,0,0)"),s.addColorStop(0,o),s.addColorStop(1,"rgba(0,0,0,0.5)"),a=0;16>a;a++)e.vuMeterData[a]=[];for(a=0;16>a;a++)for(t=0;16>t;t++)e.vuDataCanvas.setAttribute("width",16),e.vuDataCanvas.setAttribute("height",16),n.fillStyle=s,n.fillRect(0,0,7,15),n.fillRect(8,0,7,15),n.fillStyle=i,n.fillRect(0,15-a,7,16-(16-a)),n.fillRect(8,15-t,7,16-(16-t)),n.clearRect(0,3,16,1),n.clearRect(0,7,16,1),n.clearRect(0,11,16,1),e.vuMeterData[a][t]=e.vuDataCanvas.toDataURL("image/png")},this.testCanvas=function(){var a,t=document.createElement("canvas"),e=null;if(!t||"undefined"==typeof t.getContext)return null;if(e=t.getContext("2d"),!e||"function"!=typeof t.toDataURL)return null;try{a=t.toDataURL("image/png")}catch(n){return null}return t},this.init=function(){t.config.useFavIcon&&(e.vuDataCanvas=e.testCanvas(),e.vuDataCanvas&&(s||i)?e.createVUData():t.config.useFavIcon=!1)},this.init()},t.prototype.Metadata=function(a,t){soundManager._wD("Metadata()");{var e,n,i=this,s=a._360data.oUI360,o=s.getElementsByTagName("ul")[0],d=o.getElementsByTagName("li");navigator.userAgent.match(/firefox/i)}for(this.lastWPExec=0,this.refreshInterval=250,this.totalTime=0,this.events={whileplaying:function(){var e,n,s,o=a._360data.width,d=a._360data.radius,r=a.durationEstimate||1e3*i.totalTime,l=null;for(e=0,n=i.data.length;n>e;e++)l=e%2===0,t.drawSolidArc(a._360data.oCanvas,l?t.config.segmentRingColorAlt:t.config.segmentRingColor,l?o:o,l?d/2:d/2,t.deg2rad(360*(i.data[e].endTimeMS/r)),t.deg2rad(360*((i.data[e].startTimeMS||1)/r)),!0);s=new Date,s-i.lastWPExec>i.refreshInterval&&(i.refresh(),i.lastWPExec=s)}},this.refresh=function(){var t,e,n=null,i=a.position,s=a._360data.metadata.data;for(t=0,e=s.length;e>t;t++)if(i>=s[t].startTimeMS&&i<=s[t].endTimeMS){n=t;break}n!==s.currentItem&&n<s.length&&(a._360data.oLink.innerHTML=s.mainTitle+' <span class="metadata"><span class="sm2_divider"> | </span><span class="sm2_metadata">'+s[n].title+"</span></span>",s.currentItem=n)},this.strToTime=function(a){var t,e=a.split(":"),n=0;for(t=e.length;t--;)n+=parseInt(e[t],10)*Math.pow(60,e.length-1-t);return n},this.data=[],this.data.givenDuration=null,this.data.currentItem=null,this.data.mainTitle=a._360data.oLink.innerHTML,e=0;e<d.length;e++)this.data[e]={o:null,title:d[e].getElementsByTagName("p")[0].innerHTML,startTime:d[e].getElementsByTagName("span")[0].innerHTML,startSeconds:i.strToTime(d[e].getElementsByTagName("span")[0].innerHTML.replace(/[()]/g,"")),duration:0,durationMS:null,startTimeMS:null,endTimeMS:null,oNote:null};for(n=t.getElementsByClassName("duration","div",s),this.data.givenDuration=n.length?1e3*i.strToTime(n[0].innerHTML):0,e=0;e<this.data.length;e++)this.data[e].duration=parseInt(this.data[e+1]?this.data[e+1].startSeconds:(i.data.givenDuration?i.data.givenDuration:a.durationEstimate)/1e3,10)-this.data[e].startSeconds,this.data[e].startTimeMS=1e3*this.data[e].startSeconds,this.data[e].durationMS=1e3*this.data[e].duration,this.data[e].endTimeMS=this.data[e].startTimeMS+this.data[e].durationMS,this.totalTime+=this.data[e].duration},navigator.userAgent.match(/webkit/i)&&navigator.userAgent.match(/mobile/i)&&soundManager.setup({useHTML5Audio:!0}),soundManager.setup({html5PollingInterval:50,debugMode:a.location.href.match(/debug=1/i),consoleOnly:!0,flashVersion:9,useHighPerformance:!0}),soundManager.debugMode&&a.setInterval(function(){var t=a.threeSixtyPlayer;t&&t.lastSound&&t.lastSound._360data.fps&&"undefined"==typeof a.isHome&&(soundManager._writeDebug("fps: ~"+t.lastSound._360data.fps),t.lastSound._360data.fps=0)},1e3),a.ThreeSixtyPlayer=t}(window),threeSixtyPlayer=new ThreeSixtyPlayer,soundManager.onready(threeSixtyPlayer.init);;
